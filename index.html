<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASRC Digital Library | 西アジア文明研究センター電子図書館</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Light mode colors (default) */
            --primary-bg: #f8f9fa;
            --secondary-bg: #ffffff;
            --accent-blue: #0066cc;
            --accent-purple: #6b46c1;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --card-bg: #ffffff;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-bg: #f3f4f6;
            --hover-bg: rgba(0, 102, 204, 0.05);
        }
        
        /* Dark mode colors */
        [data-theme="dark"] {
            --primary-bg: #0a0e27;
            --secondary-bg: #1a1f3a;
            --accent-blue: #00d4ff;
            --accent-purple: #7c3aed;
            --text-primary: #e0e7ff;
            --text-secondary: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.8);
            --border-color: rgba(99, 102, 241, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --input-bg: rgba(10, 14, 39, 0.6);
            --hover-bg: rgba(0, 212, 255, 0.05);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Background pattern for light mode */
        .bg-pattern {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.02;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(0, 102, 204, 0.1) 35px, rgba(0, 102, 204, 0.1) 70px);
        }
        
        [data-theme="dark"] .bg-pattern {
            opacity: 0.1;
            background-image: 
                radial-gradient(circle at 20% 50%, var(--accent-blue) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--accent-purple) 0%, transparent 50%);
        }
        
        /* Header */
        header {
            background: var(--secondary-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .logo-img {
            height: 60px;
            width: auto;
        }
        
        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 0.25rem;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* Theme toggle */
        .theme-toggle {
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .theme-toggle:hover {
            border-color: var(--accent-blue);
            background: var(--hover-bg);
        }
        
        /* Status Section */
        .status-section {
            padding: 1.5rem 0;
            text-align: center;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
        }
        
        .status-message {
            padding: 0.75rem 1.5rem;
            background: var(--card-bg);
            border-radius: 10px;
            display: inline-block;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        
        .status-loading {
            color: var(--accent-blue);
        }
        
        .status-success {
            color: #10b981;
        }
        
        .status-error {
            color: #ef4444;
        }
        
        /* Search Section */
        .search-section {
            padding: 3rem 0;
        }
        
        .search-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 20px var(--shadow-color);
        }
        
        .search-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .search-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 30px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .search-tab:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .search-tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            box-shadow: 0 3px 10px rgba(0, 102, 204, 0.3);
        }
        
        .search-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .search-input-container {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 1.25rem 1.5rem 1.25rem 3.5rem;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            color: var(--text-primary);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .search-button {
            padding: 1rem 2rem;
            background: var(--accent-blue);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 102, 204, 0.3);
        }
        
        .search-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.4);
        }
        
        .search-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Results Section */
        .results-section {
            padding: 2rem 0 4rem;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .results-count {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .sort-options {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .sort-select {
            padding: 0.5rem 1rem;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        /* Result Cards */
        .result-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--accent-blue);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .result-card:hover::before {
            opacity: 1;
        }
        
        .result-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .result-title:hover {
            color: var(--accent-purple);
        }
        
        .result-authors {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }
        
        .result-meta {
            display: flex;
            gap: 2rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .result-abstract {
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .result-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .tag {
            padding: 0.25rem 0.75rem;
            background: var(--hover-bg);
            border: 1px solid var(--accent-purple);
            border-radius: 15px;
            color: var(--accent-purple);
            font-size: 0.8rem;
        }
        
        .result-bibtex-key {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--hover-bg);
            border: 1px solid var(--accent-blue);
            border-radius: 20px;
            color: var(--accent-blue);
            font-size: 0.85rem;
            font-family: monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .result-bibtex-key:hover {
            background: var(--accent-blue);
            color: white;
            transform: scale(1.05);
        }
        
        /* Detail Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            max-width: 800px;
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
            background: none;
            border: none;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .detail-section {
            margin-bottom: 1.5rem;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }
        
        .detail-value {
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* Highlight */
        mark {
            background: rgba(0, 102, 204, 0.2);
            color: inherit;
            padding: 0 2px;
            border-radius: 3px;
        }
        
        [data-theme="dark"] mark {
            background: rgba(0, 212, 255, 0.3);
        }
        
        /* Loading Animation */
        .loader {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loader.active {
            display: block;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                justify-content: center;
            }
            
            .logo-section {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-img {
                height: 50px;
            }
            
            .search-header {
                justify-content: center;
            }
            
            .results-header {
                flex-direction: column;
                align-items: start;
            }
            
            .modal-content {
                margin: 2% 1rem;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <img src="https://rcwac-histanth.whowp03.cc.tsukuba.ac.jp/content/uploads/sites/21/2021/07/logo.png" 
                         alt="西アジア文明研究センター" 
                         class="logo-img">
                    <div class="logo-text">
                        <h1>WASRC Digital Library</h1>
                        <p>西アジア文明研究センター電子図書館</p>
                        <p style="font-size: 0.85rem;">Research Center for West Asian Civilization</p>
                    </div>
                </div>
                <div class="header-controls">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <span id="themeIcon">🌙</span>
                        <span id="themeText">ダークモード</span>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <section class="status-section">
            <div class="container">
                <div class="status-message" id="statusMessage">
                    <span class="status-loading">📖 BibTeXファイルを読み込み中...</span>
                </div>
            </div>
        </section>
        
        <section class="search-section">
            <div class="container">
                <div class="search-container">
                    <div class="search-header">
                        <button class="search-tab active" onclick="setSearchType('all')">総合検索</button>
                        <button class="search-tab" onclick="setSearchType('title')">書名検索</button>
                        <button class="search-tab" onclick="setSearchType('author')">著者検索</button>
                        <button class="search-tab" onclick="setSearchType('keyword')">キーワード検索</button>
                        <button class="search-tab" onclick="setSearchType('year')">出版年検索</button>
                    </div>
                    
                    <form class="search-form" onsubmit="performSearch(event)">
                        <div class="search-input-container">
                            <span class="search-icon">🔍</span>
                            <input type="text" class="search-input" placeholder="データを読み込み中..." id="searchInput" disabled>
                        </div>
                        
                        <button type="submit" class="search-button" id="searchButton" disabled>検索実行</button>
                    </form>
                </div>
            </div>
        </section>
        
        <section class="results-section">
            <div class="container">
                <div class="results-header">
                    <div class="results-count" id="resultsCount">データベースを読み込み中...</div>
                    <div class="sort-options">
                        <label for="sortSelect" style="color: var(--text-secondary);">並び替え:</label>
                        <select id="sortSelect" class="sort-select" onchange="sortResults()">
                            <option value="relevance">関連度順</option>
                            <option value="year-desc">出版年（新しい順）</option>
                            <option value="year-asc">出版年（古い順）</option>
                            <option value="title">タイトル順</option>
                            <option value="author">著者名順</option>
                        </select>
                    </div>
                </div>
                
                <div class="loader" id="loader">
                    <div class="loader-spinner"></div>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">検索中...</p>
                </div>
                
                <div id="resultsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">⏳</div>
                        <p>データベースを読み込んでいます...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <script>
        let bibData = [];
        let currentSearchType = 'all';
        let currentSearchResults = [];
        const BIBTEX_FILENAME = 'export-data.bib';
        
        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeToggle(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeToggle(newTheme);
        }
        
        function updateThemeToggle(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (theme === 'dark') {
                icon.textContent = '☀️';
                text.textContent = 'ライトモード';
            } else {
                icon.textContent = '🌙';
                text.textContent = 'ダークモード';
            }
        }
        
        // BibTeX Parser
        class BibTeXParser {
            constructor() {
                this.entries = [];
            }
            
            parse(bibtexString) {
                this.entries = [];
                const entryRegex = /@(\w+)\s*\{([^,]+),\s*([\s\S]*?)\n\}/gm;
                let match;
                
                while ((match = entryRegex.exec(bibtexString)) !== null) {
                    const entryType = match[1].toLowerCase();
                    const citationKey = match[2].trim();
                    const fieldsString = match[3];
                    
                    const fields = this.parseFields(fieldsString);
                    fields.entryType = entryType;
                    fields.citationKey = citationKey;
                    
                    this.entries.push(fields);
                }
                
                return this.entries;
            }
            
            parseFields(fieldsString) {
                const fields = {};
                const fieldRegex = /(\w+)\s*=\s*(?:\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}|"([^"]*)"|(\d+))/g;
                let match;
                
                while ((match = fieldRegex.exec(fieldsString)) !== null) {
                    const fieldName = match[1].toLowerCase();
                    const fieldValue = match[2] || match[3] || match[4] || '';
                    fields[fieldName] = this.cleanFieldValue(fieldValue);
                }
                
                return fields;
            }
            
            cleanFieldValue(value) {
                // Remove LaTeX commands and clean up
                return value
                    .replace(/\\textit\{([^}]+)\}/g, '$1')
                    .replace(/\\emph\{([^}]+)\}/g, '$1')
                    .replace(/\\textbf\{([^}]+)\}/g, '$1')
                    .replace(/\\'([aeiouy])/g, '$1́')
                    .replace(/\\`([aeiouy])/g, '$1̀')
                    .replace(/\\"([aeiouy])/g, '$1̈')
                    .replace(/\\~([aon])/g, '$1̃')
                    .replace(/\\\^([aeiouy])/g, '$1̂')
                    .replace(/\\c\{([cC])\}/g, '$1̧')
                    .replace(/\\&/g, '&')
                    .replace(/\\\$/g, '$')
                    .replace(/\\%/g, '%')
                    .replace(/\\#/g, '#')
                    .replace(/\\_/g, '_')
                    .replace(/\{|\}/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            }
        }
        
        // Load BibTeX file on page load
        async function loadBibTeXFile() {
            const statusMessage = document.getElementById('statusMessage');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            
            try {
                // Read the BibTeX file
                const content = await window.fs.readFile(BIBTEX_FILENAME, { encoding: 'utf8' });
                
                // Parse the BibTeX content
                parseBibTeX(content);
                
                // Update status
                statusMessage.innerHTML = `<span class="status-success">✅ ${BIBTEX_FILENAME} を読み込みました (${bibData.length}件の文献)</span>`;
                
                // Enable search
                searchInput.disabled = false;
                searchButton.disabled = false;
                searchInput.placeholder = '検索キーワードを入力してください...';
                
                // Update results count and display all results
                document.getElementById('resultsCount').textContent = `データベース: ${bibData.length}件`;
                displayAllResults();
                
            } catch (error) {
                console.error('Error loading BibTeX file:', error);
                statusMessage.innerHTML = `<span class="status-error">❌ エラー: ${BIBTEX_FILENAME} が見つかりません。ファイルがHTMLと同じフォルダにあることを確認してください。</span>`;
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">❌</div>
                        <p>BibTeXファイルの読み込みに失敗しました</p>
                        <p style="font-size: 0.9rem; margin-top: 1rem;">ファイル名: ${BIBTEX_FILENAME}</p>
                    </div>
                `;
            }
        }
        
        function parseBibTeX(content) {
            const parser = new BibTeXParser();
            const entries = parser.parse(content);
            
            bibData = entries.map(entry => ({
                id: entry.citationKey,
                title: entry.title || 'No title',
                authors: parseAuthors(entry.author || entry.editor || ''),
                year: entry.year || 'n.d.',
                type: mapEntryType(entry.entryType),
                journal: entry.journal || entry.booktitle || '',
                volume: entry.volume || '',
                pages: entry.pages || '',
                doi: entry.doi || '',
                isbn: entry.isbn || '',
                publisher: entry.publisher || '',
                address: entry.address || '',
                abstract: entry.abstract || '',
                keywords: entry.keywords ? entry.keywords.split(/[,;]/).map(k => k.trim()) : [],
                series: entry.series || '',
                number: entry.number || '',
                edition: entry.edition || '',
                url: entry.url || '',
                note: entry.note || '',
                language: entry.language || detectLanguage(entry.title || ''),
                citationKey: entry.citationKey
            }));
        }
        
        function parseAuthors(authorString) {
            if (!authorString) return [];
            
            // Split by 'and'
            const authors = authorString.split(/\s+and\s+/i);
            return authors.map(author => {
                // Handle "Last, First" format
                if (author.includes(',')) {
                    const [last, first] = author.split(',').map(s => s.trim());
                    return `${first} ${last}`;
                }
                return author.trim();
            });
        }
        
        function mapEntryType(type) {
            const typeMap = {
                'article': '論文',
                'book': '図書',
                'inbook': '図書の一部',
                'incollection': '論文集の一部',
                'inproceedings': '会議録',
                'conference': '会議録',
                'mastersthesis': '修士論文',
                'phdthesis': '博士論文',
                'techreport': '技術報告書',
                'manual': 'マニュアル',
                'misc': 'その他',
                'unpublished': '未刊行'
            };
            return typeMap[type.toLowerCase()] || type;
        }
        
        function detectLanguage(text) {
            // Simple language detection based on character sets
            if (/[\u0600-\u06FF]/.test(text)) return 'アラビア語';
            if (/[\u0590-\u05FF]/.test(text)) return 'ヘブライ語';
            if (/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(text)) return '日本語';
            if (/[А-Яа-я]/.test(text)) return 'ロシア語';
            
            // Check language field content
            const langLower = text.toLowerCase();
            if (langLower.includes('eng')) return '英語';
            if (langLower.includes('ger')) return 'ドイツ語';
            if (langLower.includes('akk')) return 'アッカド語';
            if (langLower.includes('uga')) return 'ウガリット語';
            if (langLower.includes('egy')) return 'エジプト語';
            
            return '英語';
        }
        
        function setSearchType(type) {
            currentSearchType = type;
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function performSearch(event) {
            event.preventDefault();
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const loader = document.getElementById('loader');
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (bibData.length === 0) {
                alert('データベースがまだ読み込まれていません');
                return;
            }
            
            // Show loader
            loader.classList.add('active');
            resultsContainer.innerHTML = '';
            
            // Simulate search delay
            setTimeout(() => {
                if (!searchTerm) {
                    currentSearchResults = [...bibData];
                } else {
                    currentSearchResults = bibData.filter(item => {
                        let searchIn = '';
                        
                        switch (currentSearchType) {
                            case 'title':
                                searchIn = item.title.toLowerCase();
                                break;
                            case 'author':
                                searchIn = item.authors.join(' ').toLowerCase();
                                break;
                            case 'keyword':
                                searchIn = item.keywords.join(' ').toLowerCase() + ' ' + item.abstract.toLowerCase();
                                break;
                            case 'year':
                                searchIn = item.year;
                                break;
                            default: // all
                                searchIn = `${item.title} ${item.authors.join(' ')} ${item.abstract} ${item.keywords.join(' ')} ${item.journal} ${item.citationKey} ${item.year} ${item.publisher}`.toLowerCase();
                        }
                        
                        return searchIn.includes(searchTerm);
                    });
                }
                
                // Apply current sort
                sortResults();
                
                // Hide loader
                loader.classList.remove('active');
                
                // Update results count
                document.getElementById('resultsCount').textContent = `検索結果: ${currentSearchResults.length}件`;
                
                // Display results
                displayResults(currentSearchResults);
            }, 300);
        }
        
        function displayAllResults() {
            currentSearchResults = [...bibData];
            displayResults(currentSearchResults);
        }
        
        function sortResults() {
            const sortType = document.getElementById('sortSelect').value;
            
            switch (sortType) {
                case 'year-desc':
                    currentSearchResults.sort((a, b) => (b.year || '0') - (a.year || '0'));
                    break;
                case 'year-asc':
                    currentSearchResults.sort((a, b) => (a.year || '9999') - (b.year || '9999'));
                    break;
                case 'title':
                    currentSearchResults.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'author':
                    currentSearchResults.sort((a, b) => {
                        const authorA = a.authors[0] || '';
                        const authorB = b.authors[0] || '';
                        return authorA.localeCompare(authorB);
                    });
                    break;
                default: // relevance or default
                    // Keep original order (relevance based on search)
                    break;
            }
            
            displayResults(currentSearchResults);
        }
        
        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <p>検索結果が見つかりませんでした</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            results.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.style.animationDelay = `${Math.min(index * 0.05, 0.5)}s`;
                
                const metaItems = [];
                if (item.year) metaItems.push(`<div class="meta-item"><span>📅</span><span>${item.year}</span></div>`);
                if (item.type) metaItems.push(`<div class="meta-item"><span>📚</span><span>${item.type}</span></div>`);
                if (item.language) metaItems.push(`<div class="meta-item"><span>🌐</span><span>${item.language}</span></div>`);
                if (item.journal) metaItems.push(`<div class="meta-item"><span>📖</span><span>${item.journal}</span></div>`);
                if (item.volume) metaItems.push(`<div class="meta-item"><span>📕</span><span>Vol. ${item.volume}</span></div>`);
                if (item.pages) metaItems.push(`<div class="meta-item"><span>📄</span><span>pp. ${item.pages}</span></div>`);
                
                const keywordsHtml = item.keywords.length > 0 ? `
                    <div class="result-tags">
                        ${item.keywords.slice(0, 5).map(keyword => `<span class="tag">${keyword}</span>`).join('')}
                        ${item.keywords.length > 5 ? `<span class="tag">+${item.keywords.length - 5}</span>` : ''}
                    </div>
                ` : '';
                
                card.innerHTML = `
                    <div class="result-header">
                        <div>
                            <h3 class="result-title" onclick="showDetails('${item.id}')">${highlightSearchTerm(item.title)}</h3>
                            <div class="result-authors">${highlightSearchTerm(item.authors.join(', ') || '著者不明')}</div>
                        </div>
                    </div>
                    
                    <div class="result-meta">
                        ${metaItems.join('')}
                    </div>
                    
                    ${item.abstract ? `<p class="result-abstract">${highlightSearchTerm(truncateText(item.abstract, 200))}</p>` : ''}
                    
                    ${keywordsHtml}
                    
                    <div class="result-bibtex-key" onclick="copyBibTeXKey('${item.citationKey}')">
                        <span>🔑</span>
                        <span>${item.citationKey}</span>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function highlightSearchTerm(text) {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }
        
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function showDetails(id) {
            const item = bibData.find(d => d.id === id);
            if (!item) return;
            
            const modal = document.getElementById('detailModal');
            const modalContent = document.getElementById('modalContent');
            
            const detailSections = [];
            
            detailSections.push(`
                <div class="detail-section">
                    <h2 style="color: var(--accent-blue); margin-bottom: 1rem;">${item.title}</h2>
                </div>
            `);
            
            if (item.authors.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">著者</div>
                        <div class="detail-value">${item.authors.join(', ')}</div>
                    </div>
                `);
            }
            
            const bibliographicInfo = [];
            if (item.year) bibliographicInfo.push(`出版年: ${item.year}`);
            if (item.type) bibliographicInfo.push(`種別: ${item.type}`);
            if (item.language) bibliographicInfo.push(`言語: ${item.language}`);
            if (item.publisher) bibliographicInfo.push(`出版社: ${item.publisher}`);
            if (item.address) bibliographicInfo.push(`出版地: ${item.address}`);
            if (item.series) bibliographicInfo.push(`シリーズ: ${item.series}`);
            if (item.number) bibliographicInfo.push(`号: ${item.number}`);
            if (item.edition) bibliographicInfo.push(`版: ${item.edition}`);
            
            if (bibliographicInfo.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">書誌情報</div>
                        <div class="detail-value">${bibliographicInfo.join('<br>')}</div>
                    </div>
                `);
            }
            
            if (item.journal || item.volume || item.pages) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">掲載情報</div>
                        <div class="detail-value">
                            ${item.journal ? `雑誌: ${item.journal}<br>` : ''}
                            ${item.volume ? `巻: ${item.volume}<br>` : ''}
                            ${item.pages ? `ページ: ${item.pages}` : ''}
                        </div>
                    </div>
                `);
            }
            
            if (item.abstract) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">要旨</div>
                        <div class="detail-value">${item.abstract}</div>
                    </div>
                `);
            }
            
            if (item.keywords.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">キーワード</div>
                        <div class="detail-value">
                            <div class="result-tags">
                                ${item.keywords.map(keyword => `<span class="tag">${keyword}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `);
            }
            
            const identifiers = [];
            if (item.isbn) identifiers.push(`ISBN: ${item.isbn}`);
            if (item.doi) identifiers.push(`DOI: ${item.doi}`);
            if (item.url) identifiers.push(`URL: <a href="${item.url}" target="_blank" style="color: var(--accent-blue);">${item.url}</a>`);
            
            if (identifiers.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">識別子</div>
                        <div class="detail-value">${identifiers.join('<br>')}</div>
                    </div>
                `);
            }
            
            detailSections.push(`
                <div class="detail-section">
                    <div class="detail-label">Citation Key</div>
                    <div class="detail-value">
                        <code style="background: var(--hover-bg); padding: 0.25rem 0.5rem; border-radius: 4px;">${item.citationKey}</code>
                    </div>
                </div>
            `);
            
            modalContent.innerHTML = detailSections.join('');
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        function copyBibTeXKey(key) {
            navigator.clipboard.writeText(`@${key}`).then(() => {
                // Show feedback
                const keyElement = event.target.closest('.result-bibtex-key');
                const originalHTML = keyElement.innerHTML;
                keyElement.innerHTML = '<span>✅</span><span>コピーしました！</span>';
                setTimeout(() => {
                    keyElement.innerHTML = originalHTML;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert(`Citation Key: @${key}`);
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Initialize on page load
        window.onload = () => {
            initTheme();
            loadBibTeXFile();
        };
    </script>
</body>
</html>