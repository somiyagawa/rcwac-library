<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASRC Digital Library | è¥¿ã‚¢ã‚¸ã‚¢æ–‡æ˜ç ”ç©¶ã‚»ãƒ³ã‚¿ãƒ¼é›»å­å›³æ›¸é¤¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Light mode colors (default) */
            --primary-bg: #f8f9fa;
            --secondary-bg: #ffffff;
            --accent-blue: #0066cc;
            --accent-purple: #6b46c1;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --card-bg: #ffffff;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-bg: #f3f4f6;
            --hover-bg: rgba(0, 102, 204, 0.05);
        }
        
        /* Dark mode colors */
        [data-theme="dark"] {
            --primary-bg: #0a0e27;
            --secondary-bg: #1a1f3a;
            --accent-blue: #00d4ff;
            --accent-purple: #7c3aed;
            --text-primary: #e0e7ff;
            --text-secondary: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.8);
            --border-color: rgba(99, 102, 241, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --input-bg: rgba(10, 14, 39, 0.6);
            --hover-bg: rgba(0, 212, 255, 0.05);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Background pattern for light mode */
        .bg-pattern {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.02;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(0, 102, 204, 0.1) 35px, rgba(0, 102, 204, 0.1) 70px);
        }
        
        [data-theme="dark"] .bg-pattern {
            opacity: 0.1;
            background-image: 
                radial-gradient(circle at 20% 50%, var(--accent-blue) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--accent-purple) 0%, transparent 50%);
        }
        
        /* Header */
        header {
            background: var(--secondary-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .logo-img {
            height: 60px;
            width: auto;
            transition: filter 0.3s ease;
        }
        
        [data-theme="dark"] .logo-img {
            filter: invert(1) brightness(0.9);
        }
        
        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 0.25rem;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* Control buttons */
        .control-button {
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .control-button:hover {
            border-color: var(--accent-blue);
            background: var(--hover-bg);
        }
        
        /* Status Section */
        .status-section {
            padding: 1.5rem 0;
            text-align: center;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
        }
        
        .status-message {
            padding: 0.75rem 1.5rem;
            background: var(--card-bg);
            border-radius: 10px;
            display: inline-block;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        
        .status-loading {
            color: var(--accent-blue);
        }
        
        .status-success {
            color: #10b981;
        }
        
        .status-error {
            color: #ef4444;
        }
        
        /* Search Section */
        .search-section {
            padding: 3rem 0;
        }
        
        .search-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 20px var(--shadow-color);
        }
        
        .search-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .search-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 30px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .search-tab:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .search-tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            box-shadow: 0 3px 10px rgba(0, 102, 204, 0.3);
        }
        
        .search-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .search-input-container {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 1.25rem 1.5rem 1.25rem 3.5rem;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            color: var(--text-primary);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .search-button {
            padding: 1rem 2rem;
            background: var(--accent-blue);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 102, 204, 0.3);
        }
        
        .search-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.4);
        }
        
        .search-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Results Section */
        .results-section {
            padding: 2rem 0 4rem;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .results-count {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .sort-options {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .sort-select {
            padding: 0.5rem 1rem;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        /* Result Cards */
        .result-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--accent-blue);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .result-card:hover::before {
            opacity: 1;
        }
        
        .result-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .result-title:hover {
            color: var(--accent-purple);
        }
        
        .result-authors {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }
        
        .result-meta {
            display: flex;
            gap: 2rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .result-abstract {
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .result-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .tag {
            padding: 0.25rem 0.75rem;
            background: var(--hover-bg);
            border: 1px solid var(--accent-purple);
            border-radius: 15px;
            color: var(--accent-purple);
            font-size: 0.8rem;
        }
        
        .result-bibtex-key {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--hover-bg);
            border: 1px solid var(--accent-blue);
            border-radius: 20px;
            color: var(--accent-blue);
            font-size: 0.85rem;
            font-family: monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .result-bibtex-key:hover {
            background: var(--accent-blue);
            color: white;
            transform: scale(1.05);
        }
        
        /* Detail Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            max-width: 800px;
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
            background: none;
            border: none;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .detail-section {
            margin-bottom: 1.5rem;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }
        
        .detail-value {
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* Highlight */
        mark {
            background: rgba(0, 102, 204, 0.2);
            color: inherit;
            padding: 0 2px;
            border-radius: 3px;
        }
        
        [data-theme="dark"] mark {
            background: rgba(0, 212, 255, 0.3);
        }
        
        /* Loading Animation */
        .loader {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loader.active {
            display: block;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Responsive Design */
                    @media (max-width: 768px) {
            .header-content {
                justify-content: center;
            }
            
            .logo-section {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-img {
                height: 50px;
            }
            
            .header-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .control-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }
            
            .search-header {
                justify-content: center;
            }
            
            .results-header {
                flex-direction: column;
                align-items: start;
            }
            
            .modal-content {
                margin: 2% 1rem;
                padding: 1.5rem;
            }
        }
        
        /* Info box */
        .info-box {
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .info-box h4 {
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <img src="https://rcwac-histanth.whowp03.cc.tsukuba.ac.jp/content/uploads/sites/21/2021/07/logo.png" 
                         alt="è¥¿ã‚¢ã‚¸ã‚¢æ–‡æ˜ç ”ç©¶ã‚»ãƒ³ã‚¿ãƒ¼" 
                         class="logo-img">
                    <div class="logo-text">
                        <h1>WASRC Digital Library</h1>
                        <p data-i18n="header.subtitle">è¥¿ã‚¢ã‚¸ã‚¢æ–‡æ˜ç ”ç©¶ã‚»ãƒ³ã‚¿ãƒ¼é›»å­å›³æ›¸é¤¨</p>
                        <p style="font-size: 0.85rem;" data-i18n="header.subtitle2">Research Center for West Asian Civilization</p>
                    </div>
                </div>
                <div class="header-controls">
                    <button class="control-button" onclick="toggleLanguage()">
                        <span id="langIcon">ğŸŒ</span>
                        <span id="langText" data-i18n="controls.language">English</span>
                    </button>
                    <button class="control-button" onclick="toggleTheme()">
                        <span id="themeIcon">ğŸŒ™</span>
                        <span id="themeText" data-i18n="controls.darkMode">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</span>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <section class="status-section">
            <div class="container">
                <div class="status-message" id="statusMessage">
                    <span class="status-loading" data-i18n="status.loading">ğŸ“– BibTeXãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
            </div>
        </section>
        
        <section class="search-section">
            <div class="container">
                <div class="search-container">
                    <div class="search-header">
                        <button class="search-tab active" onclick="setSearchType('all')" data-i18n="search.all">ç·åˆæ¤œç´¢</button>
                        <button class="search-tab" onclick="setSearchType('title')" data-i18n="search.title">æ›¸åæ¤œç´¢</button>
                        <button class="search-tab" onclick="setSearchType('author')" data-i18n="search.author">è‘—è€…æ¤œç´¢</button>
                        <button class="search-tab" onclick="setSearchType('keyword')" data-i18n="search.keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</button>
                        <button class="search-tab" onclick="setSearchType('year')" data-i18n="search.year">å‡ºç‰ˆå¹´æ¤œç´¢</button>
                    </div>
                    
                    <form class="search-form" onsubmit="performSearch(event)">
                        <div class="search-input-container">
                            <span class="search-icon">ğŸ”</span>
                            <input type="text" class="search-input" data-i18n-placeholder="search.placeholder" placeholder="ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­..." id="searchInput" disabled>
                        </div>
                        
                        <button type="submit" class="search-button" id="searchButton" data-i18n="search.button" disabled>æ¤œç´¢å®Ÿè¡Œ</button>
                    </form>
                </div>
            </div>
        </section>
        
        <section class="results-section">
            <div class="container">
                <div class="results-header">
                    <div class="results-count" id="resultsCount" data-i18n="results.loading">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    <div class="sort-options">
                        <label for="sortSelect" style="color: var(--text-secondary);" data-i18n="sort.label">ä¸¦ã³æ›¿ãˆ:</label>
                        <select id="sortSelect" class="sort-select" onchange="sortResults()">
                            <option value="relevance" data-i18n="sort.relevance">é–¢é€£åº¦é †</option>
                            <option value="year-desc" data-i18n="sort.yearDesc">å‡ºç‰ˆå¹´ï¼ˆæ–°ã—ã„é †ï¼‰</option>
                            <option value="year-asc" data-i18n="sort.yearAsc">å‡ºç‰ˆå¹´ï¼ˆå¤ã„é †ï¼‰</option>
                            <option value="title" data-i18n="sort.title">ã‚¿ã‚¤ãƒˆãƒ«é †</option>
                            <option value="author" data-i18n="sort.author">è‘—è€…åé †</option>
                        </select>
                    </div>
                </div>
                
                <div class="loader" id="loader">
                    <div class="loader-spinner"></div>
                    <p style="margin-top: 1rem; color: var(--text-secondary);" data-i18n="loader.searching">æ¤œç´¢ä¸­...</p>
                </div>
                
                <div id="resultsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">â³</div>
                        <p data-i18n="empty.loading">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <script>
        let bibData = [];
        let currentSearchType = 'all';
        let currentSearchResults = [];
        let currentLanguage = 'ja';
        const BIBTEX_FILENAME = 'export-data.bib';
        
        // Translation data
        const translations = {
            ja: {
                header: {
                    subtitle: 'è¥¿ã‚¢ã‚¸ã‚¢æ–‡æ˜ç ”ç©¶ã‚»ãƒ³ã‚¿ãƒ¼é›»å­å›³æ›¸é¤¨',
                    subtitle2: 'Research Center for West Asian Civilization'
                },
                controls: {
                    language: 'English',
                    darkMode: 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰',
                    lightMode: 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰'
                },
                status: {
                    loading: 'ğŸ“– BibTeXãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...',
                    success: 'âœ… {filename} ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ ({count}ä»¶ã®æ–‡çŒ®)',
                    error: 'âŒ ã‚¨ãƒ©ãƒ¼: {filename} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒHTMLã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
                },
                search: {
                    all: 'ç·åˆæ¤œç´¢',
                    title: 'æ›¸åæ¤œç´¢',
                    author: 'è‘—è€…æ¤œç´¢',
                    keyword: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢',
                    year: 'å‡ºç‰ˆå¹´æ¤œç´¢',
                    placeholder: 'æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...',
                    placeholderLoading: 'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...',
                    button: 'æ¤œç´¢å®Ÿè¡Œ'
                },
                results: {
                    loading: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã¿ä¸­...',
                    database: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: {count}ä»¶',
                    searchResults: 'æ¤œç´¢çµæœ: {count}ä»¶'
                },
                sort: {
                    label: 'ä¸¦ã³æ›¿ãˆ:',
                    relevance: 'é–¢é€£åº¦é †',
                    yearDesc: 'å‡ºç‰ˆå¹´ï¼ˆæ–°ã—ã„é †ï¼‰',
                    yearAsc: 'å‡ºç‰ˆå¹´ï¼ˆå¤ã„é †ï¼‰',
                    title: 'ã‚¿ã‚¤ãƒˆãƒ«é †',
                    author: 'è‘—è€…åé †'
                },
                loader: {
                    searching: 'æ¤œç´¢ä¸­...'
                },
                empty: {
                    loading: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...',
                    noResults: 'æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ',
                    error: 'BibTeXãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
                    fileName: 'ãƒ•ã‚¡ã‚¤ãƒ«å: {filename}'
                },
                detail: {
                    author: 'è‘—è€…',
                    unknownAuthor: 'è‘—è€…ä¸æ˜',
                    bibliographic: 'æ›¸èªŒæƒ…å ±',
                    publicationInfo: 'æ²è¼‰æƒ…å ±',
                    abstract: 'è¦æ—¨',
                    keywords: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰',
                    identifiers: 'è­˜åˆ¥å­',
                    year: 'å‡ºç‰ˆå¹´',
                    type: 'ç¨®åˆ¥',
                    language: 'è¨€èª',
                    publisher: 'å‡ºç‰ˆç¤¾',
                    address: 'å‡ºç‰ˆåœ°',
                    series: 'ã‚·ãƒªãƒ¼ã‚º',
                    number: 'å·',
                    edition: 'ç‰ˆ',
                    journal: 'é›‘èªŒ',
                    volume: 'å·»',
                    pages: 'ãƒšãƒ¼ã‚¸',
                    copied: 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'
                },
                alert: {
                    dbNotLoaded: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'
                }
            },
            en: {
                header: {
                    subtitle: 'Digital Library of Research Center for West Asian Civilization',
                    subtitle2: 'University of Tsukuba'
                },
                controls: {
                    language: 'æ—¥æœ¬èª',
                    darkMode: 'Dark Mode',
                    lightMode: 'Light Mode'
                },
                status: {
                    loading: 'ğŸ“– Loading BibTeX file...',
                    success: 'âœ… Loaded {filename} ({count} references)',
                    error: 'âŒ Error: {filename} not found. Please ensure the file is in the same folder as the HTML file.'
                },
                search: {
                    all: 'All Fields',
                    title: 'Title',
                    author: 'Author',
                    keyword: 'Keywords',
                    year: 'Year',
                    placeholder: 'Enter search keywords...',
                    placeholderLoading: 'Loading data...',
                    button: 'Search'
                },
                results: {
                    loading: 'Loading database...',
                    database: 'Database: {count} items',
                    searchResults: 'Search results: {count} items'
                },
                sort: {
                    label: 'Sort by:',
                    relevance: 'Relevance',
                    yearDesc: 'Year (Newest first)',
                    yearAsc: 'Year (Oldest first)',
                    title: 'Title',
                    author: 'Author'
                },
                loader: {
                    searching: 'Searching...'
                },
                empty: {
                    loading: 'Loading database...',
                    noResults: 'No results found',
                    error: 'Failed to load BibTeX file',
                    fileName: 'File name: {filename}'
                },
                detail: {
                    author: 'Author(s)',
                    unknownAuthor: 'Unknown author',
                    bibliographic: 'Bibliographic Information',
                    publicationInfo: 'Publication Details',
                    abstract: 'Abstract',
                    keywords: 'Keywords',
                    identifiers: 'Identifiers',
                    year: 'Year',
                    type: 'Type',
                    language: 'Language',
                    publisher: 'Publisher',
                    address: 'Place',
                    series: 'Series',
                    number: 'Number',
                    edition: 'Edition',
                    journal: 'Journal',
                    volume: 'Volume',
                    pages: 'Pages',
                    copied: 'Copied!'
                },
                alert: {
                    dbNotLoaded: 'Database not loaded yet'
                }
            }
        };
        
        // Language type mappings
        const languageNames = {
            ja: {
                'ã‚¢ãƒ©ãƒ“ã‚¢èª': 'ã‚¢ãƒ©ãƒ“ã‚¢èª',
                'ãƒ˜ãƒ–ãƒ©ã‚¤èª': 'ãƒ˜ãƒ–ãƒ©ã‚¤èª',
                'æ—¥æœ¬èª': 'æ—¥æœ¬èª',
                'ãƒ­ã‚·ã‚¢èª': 'ãƒ­ã‚·ã‚¢èª',
                'è‹±èª': 'è‹±èª',
                'ãƒ‰ã‚¤ãƒ„èª': 'ãƒ‰ã‚¤ãƒ„èª',
                'ã‚¢ãƒƒã‚«ãƒ‰èª': 'ã‚¢ãƒƒã‚«ãƒ‰èª',
                'ã‚¦ã‚¬ãƒªãƒƒãƒˆèª': 'ã‚¦ã‚¬ãƒªãƒƒãƒˆèª',
                'ã‚¨ã‚¸ãƒ—ãƒˆèª': 'ã‚¨ã‚¸ãƒ—ãƒˆèª'
            },
            en: {
                'ã‚¢ãƒ©ãƒ“ã‚¢èª': 'Arabic',
                'ãƒ˜ãƒ–ãƒ©ã‚¤èª': 'Hebrew',
                'æ—¥æœ¬èª': 'Japanese',
                'ãƒ­ã‚·ã‚¢èª': 'Russian',
                'è‹±èª': 'English',
                'ãƒ‰ã‚¤ãƒ„èª': 'German',
                'ã‚¢ãƒƒã‚«ãƒ‰èª': 'Akkadian',
                'ã‚¦ã‚¬ãƒªãƒƒãƒˆèª': 'Ugaritic',
                'ã‚¨ã‚¸ãƒ—ãƒˆèª': 'Egyptian'
            }
        };
        
        // Entry type mappings
        const entryTypeNames = {
            ja: {
                'è«–æ–‡': 'è«–æ–‡',
                'å›³æ›¸': 'å›³æ›¸',
                'å›³æ›¸ã®ä¸€éƒ¨': 'å›³æ›¸ã®ä¸€éƒ¨',
                'è«–æ–‡é›†ã®ä¸€éƒ¨': 'è«–æ–‡é›†ã®ä¸€éƒ¨',
                'ä¼šè­°éŒ²': 'ä¼šè­°éŒ²',
                'ä¿®å£«è«–æ–‡': 'ä¿®å£«è«–æ–‡',
                'åšå£«è«–æ–‡': 'åšå£«è«–æ–‡',
                'æŠ€è¡“å ±å‘Šæ›¸': 'æŠ€è¡“å ±å‘Šæ›¸',
                'ãƒãƒ‹ãƒ¥ã‚¢ãƒ«': 'ãƒãƒ‹ãƒ¥ã‚¢ãƒ«',
                'ãã®ä»–': 'ãã®ä»–',
                'æœªåˆŠè¡Œ': 'æœªåˆŠè¡Œ'
            },
            en: {
                'è«–æ–‡': 'Article',
                'å›³æ›¸': 'Book',
                'å›³æ›¸ã®ä¸€éƒ¨': 'Book Chapter',
                'è«–æ–‡é›†ã®ä¸€éƒ¨': 'In Collection',
                'ä¼šè­°éŒ²': 'Conference Paper',
                'ä¿®å£«è«–æ–‡': 'Master\'s Thesis',
                'åšå£«è«–æ–‡': 'PhD Thesis',
                'æŠ€è¡“å ±å‘Šæ›¸': 'Technical Report',
                'ãƒãƒ‹ãƒ¥ã‚¢ãƒ«': 'Manual',
                'ãã®ä»–': 'Other',
                'æœªåˆŠè¡Œ': 'Unpublished'
            }
        };
        
        // Get translation
        function t(key) {
            const keys = key.split('.');
            let value = translations[currentLanguage];
            for (const k of keys) {
                value = value[k];
            }
            return value;
        }
        
        // Safe storage access
        const safeStorage = {
            getItem: (key) => {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.log('localStorage not available, using defaults');
                    return null;
                }
            },
            setItem: (key, value) => {
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    console.log('localStorage not available, changes will not persist');
                }
            }
        };
        
        // Initialize theme and language
        function initSettings() {
            const savedTheme = safeStorage.getItem('theme') || 'light';
            const savedLang = safeStorage.getItem('language') || 'ja';
            
            document.documentElement.setAttribute('data-theme', savedTheme);
            currentLanguage = savedLang;
            document.documentElement.setAttribute('lang', savedLang);
            
            updateThemeToggle(savedTheme);
            updateLanguageToggle(savedLang);
            updateAllTranslations();
        }
        
        // Toggle theme
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            safeStorage.setItem('theme', newTheme);
            updateThemeToggle(newTheme);
        }
        
        function updateThemeToggle(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (theme === 'dark') {
                icon.textContent = 'â˜€ï¸';
                text.textContent = t('controls.lightMode');
            } else {
                icon.textContent = 'ğŸŒ™';
                text.textContent = t('controls.darkMode');
            }
        }
        
        // Toggle language
        function toggleLanguage() {
            const newLang = currentLanguage === 'ja' ? 'en' : 'ja';
            currentLanguage = newLang;
            safeStorage.setItem('language', newLang);
            document.documentElement.setAttribute('lang', newLang);
            updateLanguageToggle(newLang);
            updateAllTranslations();
            
            // Update search results if any
            if (currentSearchResults.length > 0) {
                displayResults(currentSearchResults);
            }
        }
        
        function updateLanguageToggle(lang) {
            const text = document.getElementById('langText');
            text.textContent = t('controls.language');
        }
        
        // Update all translations
        function updateAllTranslations() {
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });
            
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                element.placeholder = t(key);
            });
            
            // Update theme toggle text
            const currentTheme = document.documentElement.getAttribute('data-theme');
            updateThemeToggle(currentTheme);
            
            // Update page title
            document.title = currentLanguage === 'ja' 
                ? 'WASRC Digital Library | è¥¿ã‚¢ã‚¸ã‚¢æ–‡æ˜ç ”ç©¶ã‚»ãƒ³ã‚¿ãƒ¼é›»å­å›³æ›¸é¤¨'
                : 'WASRC Digital Library | Research Center for West Asian Civilization';
            
            // Update current status message if needed
            const statusMessage = document.getElementById('statusMessage');
            if (statusMessage.querySelector('.status-success')) {
                statusMessage.innerHTML = `<span class="status-success">${t('status.success').replace('{filename}', BIBTEX_FILENAME).replace('{count}', bibData.length)}</span>`;
            } else if (statusMessage.querySelector('.status-error') && statusMessage.querySelector('button')) {
                // Re-render the manual upload button with correct language
                statusMessage.innerHTML = `
                    <span class="status-error">${currentLanguage === 'ja' 
                        ? 'è‡ªå‹•èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' 
                        : 'Failed to load automatically.'}</span>
                    <input type="file" id="manualFileInput" accept=".bib,.bibtex" style="display: none;">
                    <button class="control-button" style="margin-left: 1rem;" onclick="document.getElementById('manualFileInput').click()">
                        ğŸ“ ${currentLanguage === 'ja' ? 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ' : 'Select File'}
                    </button>
                `;
                
                // Re-attach the file input handler
                document.getElementById('manualFileInput').addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const content = e.target.result;
                            parseBibTeX(content);
                            
                            statusMessage.innerHTML = `<span class="status-success">${t('status.success').replace('{filename}', file.name).replace('{count}', bibData.length)}</span>`;
                            
                            const searchInput = document.getElementById('searchInput');
                            const searchButton = document.getElementById('searchButton');
                            searchInput.disabled = false;
                            searchButton.disabled = false;
                            searchInput.placeholder = t('search.placeholder');
                            
                            document.getElementById('resultsCount').textContent = t('results.database').replace('{count}', bibData.length);
                            displayAllResults();
                        };
                        reader.readAsText(file);
                    }
                });
            }
            
            // Update results count
            const resultsCount = document.getElementById('resultsCount');
            if (resultsCount.textContent.includes(':')) {
                if (currentSearchResults.length > 0 && currentSearchResults.length !== bibData.length) {
                    resultsCount.textContent = t('results.searchResults').replace('{count}', currentSearchResults.length);
                } else if (bibData.length > 0) {
                    resultsCount.textContent = t('results.database').replace('{count}', bibData.length);
                }
            }
        }
        
        // BibTeX Parser
        class BibTeXParser {
            constructor() {
                this.entries = [];
            }
            
            parse(bibtexString) {
                this.entries = [];
                const entryRegex = /@(\w+)\s*\{([^,]+),\s*([\s\S]*?)\n\}/gm;
                let match;
                
                while ((match = entryRegex.exec(bibtexString)) !== null) {
                    const entryType = match[1].toLowerCase();
                    const citationKey = match[2].trim();
                    const fieldsString = match[3];
                    
                    const fields = this.parseFields(fieldsString);
                    fields.entryType = entryType;
                    fields.citationKey = citationKey;
                    
                    this.entries.push(fields);
                }
                
                return this.entries;
            }
            
            parseFields(fieldsString) {
                const fields = {};
                const fieldRegex = /(\w+)\s*=\s*(?:\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}|"([^"]*)"|(\d+))/g;
                let match;
                
                while ((match = fieldRegex.exec(fieldsString)) !== null) {
                    const fieldName = match[1].toLowerCase();
                    const fieldValue = match[2] || match[3] || match[4] || '';
                    fields[fieldName] = this.cleanFieldValue(fieldValue);
                }
                
                return fields;
            }
            
            cleanFieldValue(value) {
                // Remove LaTeX commands and clean up
                return value
                    .replace(/\\textit\{([^}]+)\}/g, '$1')
                    .replace(/\\emph\{([^}]+)\}/g, '$1')
                    .replace(/\\textbf\{([^}]+)\}/g, '$1')
                    .replace(/\\'([aeiouy])/g, '$1Ì')
                    .replace(/\\`([aeiouy])/g, '$1Ì€')
                    .replace(/\\"([aeiouy])/g, '$1Ìˆ')
                    .replace(/\\~([aon])/g, '$1Ìƒ')
                    .replace(/\\\^([aeiouy])/g, '$1Ì‚')
                    .replace(/\\c\{([cC])\}/g, '$1Ì§')
                    .replace(/\\&/g, '&')
                    .replace(/\\\$/g, '$')
                    .replace(/\\%/g, '%')
                    .replace(/\\#/g, '#')
                    .replace(/\\_/g, '_')
                    .replace(/\{|\}/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            }
        }
        
        // Load BibTeX file on page load
        async function loadBibTeXFile() {
            const statusMessage = document.getElementById('statusMessage');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            
            let content = null;
            
            // Method 1: Try window.fs.readFile (for Claude environment)
            if (window.fs && window.fs.readFile) {
                try {
                    content = await window.fs.readFile(BIBTEX_FILENAME, { encoding: 'utf8' });
                } catch (error) {
                    console.log('window.fs.readFile failed, trying fetch...');
                }
            }
            
            // Method 2: Try fetch (for web server)
            if (!content) {
                try {
                    const response = await fetch(BIBTEX_FILENAME);
                    if (response.ok) {
                        content = await response.text();
                    }
                } catch (error) {
                    console.log('Fetch failed, showing manual upload option...');
                }
            }
            
            // If content was loaded successfully
            if (content) {
                // Parse the BibTeX content
                parseBibTeX(content);
                
                // Update status
                statusMessage.innerHTML = `<span class="status-success">${t('status.success').replace('{filename}', BIBTEX_FILENAME).replace('{count}', bibData.length)}</span>`;
                
                // Enable search
                searchInput.disabled = false;
                searchButton.disabled = false;
                searchInput.placeholder = t('search.placeholder');
                
                // Update results count and display all results
                document.getElementById('resultsCount').textContent = t('results.database').replace('{count}', bibData.length);
                displayAllResults();
            } else {
                // Show manual upload option
                console.error('Could not load BibTeX file automatically');
                statusMessage.innerHTML = `
                    <span class="status-error">${currentLanguage === 'ja' 
                        ? 'è‡ªå‹•èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' 
                        : 'Failed to load automatically.'}</span>
                    <input type="file" id="manualFileInput" accept=".bib,.bibtex" style="display: none;">
                    <button class="control-button" style="margin-left: 1rem;" onclick="document.getElementById('manualFileInput').click()">
                        ğŸ“ ${currentLanguage === 'ja' ? 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ' : 'Select File'}
                    </button>
                `;
                
                // Add file input handler
                document.getElementById('manualFileInput').addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const content = e.target.result;
                            parseBibTeX(content);
                            
                            statusMessage.innerHTML = `<span class="status-success">${t('status.success').replace('{filename}', file.name).replace('{count}', bibData.length)}</span>`;
                            
                            searchInput.disabled = false;
                            searchButton.disabled = false;
                            searchInput.placeholder = t('search.placeholder');
                            
                            document.getElementById('resultsCount').textContent = t('results.database').replace('{count}', bibData.length);
                            displayAllResults();
                        };
                        reader.readAsText(file);
                    }
                });
                
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <p>${currentLanguage === 'ja' 
                            ? 'BibTeXãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„' 
                            : 'Please select a BibTeX file'}</p>
                        <div class="info-box" style="text-align: left; max-width: 600px; margin: 2rem auto;">
                            <h4>${currentLanguage === 'ja' ? 'ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«ã¤ã„ã¦' : 'About File Loading'}</h4>
                            <p>${currentLanguage === 'ja' 
                                ? 'ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ä»¥ä¸‹ã®æ–¹æ³•ã§BibTeXãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ï¼š' 
                                : 'This system loads BibTeX files using the following methods:'}</p>
                            <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                <li>${currentLanguage === 'ja'
                                    ? 'Webã‚µãƒ¼ãƒãƒ¼çµŒç”±: HTTPã‚µãƒ¼ãƒãƒ¼ã§ãƒ›ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã€è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿ã¾ã™'
                                    : 'Via web server: Automatically loads when hosted on an HTTP server'}</li>
                                <li>${currentLanguage === 'ja'
                                    ? 'æ‰‹å‹•é¸æŠ: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„'
                                    : 'Manual selection: Select local files using the button above'}</li>
                            </ul>
                            <p style="margin-top: 1rem;">${currentLanguage === 'ja'
                                ? 'ãƒ’ãƒ³ãƒˆ: Visual Studio Codeã®Live Serverã‚„Pythonã®http.serverãªã©ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€è‡ªå‹•èª­ã¿è¾¼ã¿ãŒå¯èƒ½ã§ã™ã€‚'
                                : 'Tip: Use tools like VS Code Live Server or Python http.server for automatic loading.'}</p>
                        </div>
                    </div>
                `;
            }
        }
        
        function parseBibTeX(content) {
            const parser = new BibTeXParser();
            const entries = parser.parse(content);
            
            bibData = entries.map(entry => ({
                id: entry.citationKey,
                title: entry.title || 'No title',
                authors: parseAuthors(entry.author || entry.editor || ''),
                year: entry.year || 'n.d.',
                type: mapEntryType(entry.entryType),
                journal: entry.journal || entry.booktitle || '',
                volume: entry.volume || '',
                pages: entry.pages || '',
                doi: entry.doi || '',
                isbn: entry.isbn || '',
                publisher: entry.publisher || '',
                address: entry.address || '',
                abstract: entry.abstract || '',
                keywords: entry.keywords ? entry.keywords.split(/[,;]/).map(k => k.trim()) : [],
                series: entry.series || '',
                number: entry.number || '',
                edition: entry.edition || '',
                url: entry.url || '',
                note: entry.note || '',
                language: entry.language || detectLanguage(entry.title || ''),
                citationKey: entry.citationKey
            }));
        }
        
        function parseAuthors(authorString) {
            if (!authorString) return [];
            
            // Split by 'and'
            const authors = authorString.split(/\s+and\s+/i);
            return authors.map(author => {
                // Handle "Last, First" format
                if (author.includes(',')) {
                    const [last, first] = author.split(',').map(s => s.trim());
                    return `${first} ${last}`;
                }
                return author.trim();
            });
        }
        
        function mapEntryType(type) {
            const typeMap = {
                'article': 'è«–æ–‡',
                'book': 'å›³æ›¸',
                'inbook': 'å›³æ›¸ã®ä¸€éƒ¨',
                'incollection': 'è«–æ–‡é›†ã®ä¸€éƒ¨',
                'inproceedings': 'ä¼šè­°éŒ²',
                'conference': 'ä¼šè­°éŒ²',
                'mastersthesis': 'ä¿®å£«è«–æ–‡',
                'phdthesis': 'åšå£«è«–æ–‡',
                'techreport': 'æŠ€è¡“å ±å‘Šæ›¸',
                'manual': 'ãƒãƒ‹ãƒ¥ã‚¢ãƒ«',
                'misc': 'ãã®ä»–',
                'unpublished': 'æœªåˆŠè¡Œ'
            };
            return typeMap[type.toLowerCase()] || type;
        }
        
        function detectLanguage(text) {
            // Simple language detection based on character sets
            if (/[\u0600-\u06FF]/.test(text)) return 'ã‚¢ãƒ©ãƒ“ã‚¢èª';
            if (/[\u0590-\u05FF]/.test(text)) return 'ãƒ˜ãƒ–ãƒ©ã‚¤èª';
            if (/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(text)) return 'æ—¥æœ¬èª';
            if (/[Ğ-Ğ¯Ğ°-Ñ]/.test(text)) return 'ãƒ­ã‚·ã‚¢èª';
            
            // Check language field content
            const langLower = text.toLowerCase();
            if (langLower.includes('eng')) return 'è‹±èª';
            if (langLower.includes('ger')) return 'ãƒ‰ã‚¤ãƒ„èª';
            if (langLower.includes('akk')) return 'ã‚¢ãƒƒã‚«ãƒ‰èª';
            if (langLower.includes('uga')) return 'ã‚¦ã‚¬ãƒªãƒƒãƒˆèª';
            if (langLower.includes('egy')) return 'ã‚¨ã‚¸ãƒ—ãƒˆèª';
            
            return 'è‹±èª';
        }
        
        function setSearchType(type) {
            currentSearchType = type;
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function performSearch(event) {
            event.preventDefault();
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const loader = document.getElementById('loader');
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (bibData.length === 0) {
                alert(t('alert.dbNotLoaded'));
                return;
            }
            
            // Show loader
            loader.classList.add('active');
            resultsContainer.innerHTML = '';
            
            // Simulate search delay
            setTimeout(() => {
                if (!searchTerm) {
                    currentSearchResults = [...bibData];
                } else {
                    currentSearchResults = bibData.filter(item => {
                        let searchIn = '';
                        
                        switch (currentSearchType) {
                            case 'title':
                                searchIn = item.title.toLowerCase();
                                break;
                            case 'author':
                                searchIn = item.authors.join(' ').toLowerCase();
                                break;
                            case 'keyword':
                                searchIn = item.keywords.join(' ').toLowerCase() + ' ' + item.abstract.toLowerCase();
                                break;
                            case 'year':
                                searchIn = item.year;
                                break;
                            default: // all
                                searchIn = `${item.title} ${item.authors.join(' ')} ${item.abstract} ${item.keywords.join(' ')} ${item.journal} ${item.citationKey} ${item.year} ${item.publisher}`.toLowerCase();
                        }
                        
                        return searchIn.includes(searchTerm);
                    });
                }
                
                // Apply current sort
                sortResults();
                
                // Hide loader
                loader.classList.remove('active');
                
                // Update results count
                document.getElementById('resultsCount').textContent = t('results.searchResults').replace('{count}', currentSearchResults.length);
                
                // Display results
                displayResults(currentSearchResults);
            }, 300);
        }
        
        function displayAllResults() {
            currentSearchResults = [...bibData];
            displayResults(currentSearchResults);
        }
        
        function sortResults() {
            const sortType = document.getElementById('sortSelect').value;
            
            switch (sortType) {
                case 'year-desc':
                    currentSearchResults.sort((a, b) => (b.year || '0') - (a.year || '0'));
                    break;
                case 'year-asc':
                    currentSearchResults.sort((a, b) => (a.year || '9999') - (b.year || '9999'));
                    break;
                case 'title':
                    currentSearchResults.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'author':
                    currentSearchResults.sort((a, b) => {
                        const authorA = a.authors[0] || '';
                        const authorB = b.authors[0] || '';
                        return authorA.localeCompare(authorB);
                    });
                    break;
                default: // relevance or default
                    // Keep original order (relevance based on search)
                    break;
            }
            
            displayResults(currentSearchResults);
        }
        
        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <p>${t('empty.noResults')}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            results.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.style.animationDelay = `${Math.min(index * 0.05, 0.5)}s`;
                
                const metaItems = [];
                if (item.year) metaItems.push(`<div class="meta-item"><span>ğŸ“…</span><span>${item.year}</span></div>`);
                if (item.type) metaItems.push(`<div class="meta-item"><span>ğŸ“š</span><span>${entryTypeNames[currentLanguage][item.type] || item.type}</span></div>`);
                if (item.language) metaItems.push(`<div class="meta-item"><span>ğŸŒ</span><span>${languageNames[currentLanguage][item.language] || item.language}</span></div>`);
                if (item.journal) metaItems.push(`<div class="meta-item"><span>ğŸ“–</span><span>${item.journal}</span></div>`);
                if (item.volume) metaItems.push(`<div class="meta-item"><span>ğŸ“•</span><span>Vol. ${item.volume}</span></div>`);
                if (item.pages) metaItems.push(`<div class="meta-item"><span>ğŸ“„</span><span>pp. ${item.pages}</span></div>`);
                
                const keywordsHtml = item.keywords.length > 0 ? `
                    <div class="result-tags">
                        ${item.keywords.slice(0, 5).map(keyword => `<span class="tag">${keyword}</span>`).join('')}
                        ${item.keywords.length > 5 ? `<span class="tag">+${item.keywords.length - 5}</span>` : ''}
                    </div>
                ` : '';
                
                card.innerHTML = `
                    <div class="result-header">
                        <div>
                            <h3 class="result-title" onclick="showDetails('${item.id}')">${highlightSearchTerm(item.title)}</h3>
                            <div class="result-authors">${highlightSearchTerm(item.authors.join(', ') || t('detail.unknownAuthor'))}</div>
                        </div>
                    </div>
                    
                    <div class="result-meta">
                        ${metaItems.join('')}
                    </div>
                    
                    ${item.abstract ? `<p class="result-abstract">${highlightSearchTerm(truncateText(item.abstract, 200))}</p>` : ''}
                    
                    ${keywordsHtml}
                    
                    <div class="result-bibtex-key" onclick="copyBibTeXKey('${item.citationKey}')">
                        <span>ğŸ”‘</span>
                        <span>${item.citationKey}</span>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function highlightSearchTerm(text) {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }
        
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function showDetails(id) {
            const item = bibData.find(d => d.id === id);
            if (!item) return;
            
            const modal = document.getElementById('detailModal');
            const modalContent = document.getElementById('modalContent');
            
            const detailSections = [];
            
            detailSections.push(`
                <div class="detail-section">
                    <h2 style="color: var(--accent-blue); margin-bottom: 1rem;">${item.title}</h2>
                </div>
            `);
            
            if (item.authors.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.author')}</div>
                        <div class="detail-value">${item.authors.join(', ')}</div>
                    </div>
                `);
            }
            
            const bibliographicInfo = [];
            if (item.year) bibliographicInfo.push(`${t('detail.year')}: ${item.year}`);
            if (item.type) bibliographicInfo.push(`${t('detail.type')}: ${entryTypeNames[currentLanguage][item.type] || item.type}`);
            if (item.language) bibliographicInfo.push(`${t('detail.language')}: ${languageNames[currentLanguage][item.language] || item.language}`);
            if (item.publisher) bibliographicInfo.push(`${t('detail.publisher')}: ${item.publisher}`);
            if (item.address) bibliographicInfo.push(`${t('detail.address')}: ${item.address}`);
            if (item.series) bibliographicInfo.push(`${t('detail.series')}: ${item.series}`);
            if (item.number) bibliographicInfo.push(`${t('detail.number')}: ${item.number}`);
            if (item.edition) bibliographicInfo.push(`${t('detail.edition')}: ${item.edition}`);
            
            if (bibliographicInfo.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.bibliographic')}</div>
                        <div class="detail-value">${bibliographicInfo.join('<br>')}</div>
                    </div>
                `);
            }
            
            if (item.journal || item.volume || item.pages) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.publicationInfo')}</div>
                        <div class="detail-value">
                            ${item.journal ? `${t('detail.journal')}: ${item.journal}<br>` : ''}
                            ${item.volume ? `${t('detail.volume')}: ${item.volume}<br>` : ''}
                            ${item.pages ? `${t('detail.pages')}: ${item.pages}` : ''}
                        </div>
                    </div>
                `);
            }
            
            if (item.abstract) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.abstract')}</div>
                        <div class="detail-value">${item.abstract}</div>
                    </div>
                `);
            }
            
            if (item.keywords.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.keywords')}</div>
                        <div class="detail-value">
                            <div class="result-tags">
                                ${item.keywords.map(keyword => `<span class="tag">${keyword}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `);
            }
            
            const identifiers = [];
            if (item.isbn) identifiers.push(`ISBN: ${item.isbn}`);
            if (item.doi) identifiers.push(`DOI: ${item.doi}`);
            if (item.url) identifiers.push(`URL: <a href="${item.url}" target="_blank" style="color: var(--accent-blue);">${item.url}</a>`);
            
            if (identifiers.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.identifiers')}</div>
                        <div class="detail-value">${identifiers.join('<br>')}</div>
                    </div>
                `);
            }
            
            detailSections.push(`
                <div class="detail-section">
                    <div class="detail-label">Citation Key</div>
                    <div class="detail-value">
                        <code style="background: var(--hover-bg); padding: 0.25rem 0.5rem; border-radius: 4px;">${item.citationKey}</code>
                    </div>
                </div>
            `);
            
            modalContent.innerHTML = detailSections.join('');
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        function copyBibTeXKey(key) {
            navigator.clipboard.writeText(`@${key}`).then(() => {
                // Show feedback
                const keyElement = event.target.closest('.result-bibtex-key');
                const originalHTML = keyElement.innerHTML;
                keyElement.innerHTML = `<span>âœ…</span><span>${t('detail.copied')}</span>`;
                setTimeout(() => {
                    keyElement.innerHTML = originalHTML;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert(`Citation Key: @${key}`);
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Initialize on page load
        window.onload = () => {
            // Check for sandboxed environment
            try {
                localStorage.getItem('test');
            } catch (e) {
                console.log('Running in sandboxed environment - settings will not persist');
            }
            
            initSettings();
            loadBibTeXFile();
        };
    </script>
</body>
</html>