<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTsukuba RCWAC OPAC | 筑波大学西アジア文明研究センター蔵書デジタル目録</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Light mode colors (default) */
            --primary-bg: #ffffff;
            --secondary-bg: #f8f9fa;
            --accent-blue: #0066cc;
            --accent-purple: #6b46c1;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --card-bg: #ffffff;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.08);
            --input-bg: #f3f4f6;
            --hover-bg: rgba(0, 102, 204, 0.05);
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
        }
        
        /* Dark mode colors */
        [data-theme="dark"] {
            --primary-bg: #1a1a1a;
            --secondary-bg: #242424;
            --accent-blue: #4da3ff;
            --accent-purple: #8b5cf6;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --card-bg: #2a2a2a;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --input-bg: #333333;
            --hover-bg: rgba(77, 163, 255, 0.1);
            --success-color: #34d399;
            --error-color: #f87171;
            --warning-color: #fbbf24;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Header */
        header {
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1.2rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px var(--shadow-color);
            backdrop-filter: blur(10px);
            background: rgba(var(--secondary-bg), 0.9);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }
        
        .logo-img {
            height: 60px;
            width: auto;
        }
        
        [data-theme="dark"] .logo-img {
            filter: invert(1) brightness(0.9);
        }
        
        .logo-text {
            max-width: 600px;
        }
        
        .logo-text h1 {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 0.25rem;
            letter-spacing: 0.5px;
        }
        
        .logo-text p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.4;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* Control buttons */
        .control-button {
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .control-button:hover {
            border-color: var(--accent-blue);
            background: var(--hover-bg);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        
        /* Status Section */
        .status-section {
            padding: 1rem 0;
            text-align: center;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
        }
        
        .status-message {
            padding: 0.75rem 1.5rem;
            background: var(--card-bg);
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px var(--shadow-color);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status-loading {
            color: var(--accent-blue);
        }
        
        .status-success {
            color: var(--success-color);
        }
        
        .status-error {
            color: var(--error-color);
        }
        
        /* Search Section */
        .search-section {
            padding: 2rem 0;
            background: linear-gradient(to bottom, var(--secondary-bg), var(--primary-bg));
        }
        
        .search-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .search-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .search-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 30px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .search-tab:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            transform: translateY(-1px);
        }
        
        .search-tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.3);
        }
        
        .search-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .search-input-container {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 1.25rem 1.5rem 1.25rem 3.5rem;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            color: var(--text-primary);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
            transform: translateY(-1px);
        }
        
        .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.2rem;
        }
        
        /* Advanced Search */
        .advanced-search {
            margin-top: 1rem;
            padding: 1.5rem;
            background: var(--hover-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .advanced-search.active {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .filter-select {
            padding: 0.75rem;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        .search-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .search-button {
            padding: 1rem 2rem;
            background: var(--accent-blue);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 4px var(--shadow-color);
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .search-button:hover:not(:disabled) {
            background: var(--accent-purple);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        
        .search-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .advanced-toggle {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .advanced-toggle:hover {
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }
        
        /* Results Section */
        .results-section {
            padding: 2rem 0 4rem;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .results-info {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .results-count {
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .export-button {
            padding: 0.5rem 1rem;
            background: var(--success-color);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .export-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        
        .sort-options {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .sort-select {
            padding: 0.5rem 1rem;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        /* Result Cards */
        .result-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-blue);
            transform: translateX(-4px);
            transition: transform 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .result-card:hover::before {
            transform: translateX(0);
        }
        
        .result-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .result-title:hover {
            color: var(--accent-purple);
        }
        
        .result-authors {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }
        
        .result-meta {
            display: flex;
            gap: 2rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .result-abstract {
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .result-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .tag {
            padding: 0.25rem 0.75rem;
            background: var(--hover-bg);
            border: 1px solid var(--accent-purple);
            border-radius: 15px;
            color: var(--accent-purple);
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .tag:hover {
            background: var(--accent-purple);
            color: white;
        }
        
        .result-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .result-call-number {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 4px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        .result-call-number:hover {
            background: var(--accent-purple);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px var(--shadow-color);
        }
        
        .result-bibtex-key {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-family: monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .result-bibtex-key:hover {
            background: var(--hover-bg);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }
        
        .page-button {
            padding: 0.5rem 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 40px;
            text-align: center;
        }
        
        .page-button:hover:not(:disabled) {
            background: var(--hover-bg);
            border-color: var(--accent-blue);
        }
        
        .page-button.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        
        .page-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0 1rem;
        }
        
        /* Detail Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .modal-content {
            background: var(--card-bg);
            margin: 3% auto;
            padding: 2.5rem;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            max-width: 800px;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        
        .detail-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* Highlight */
        mark {
            background: rgba(0, 102, 204, 0.2);
            color: inherit;
            padding: 0 2px;
            border-radius: 3px;
        }
        
        [data-theme="dark"] mark {
            background: rgba(0, 212, 255, 0.3);
        }
        
        /* Loading Animation */
        .loader {
            display: none;
            text-align: center;
            padding: 3rem;
        }
        
        .loader.active {
            display: block;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Stats Dashboard */
        .stats-section {
            padding: 2rem 0;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            display: none;
        }
        
        .stats-section.visible {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow-color);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Info box */
        .info-box {
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .info-box h4 {
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            background-color: var(--text-primary);
            color: var(--primary-bg);
            text-align: center;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .header-content {
                justify-content: center;
            }
            
            .logo-section {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-img {
                height: 50px;
            }
            
            .logo-text h1 {
                font-size: 1.2rem;
            }
            
            .logo-text p {
                font-size: 0.75rem;
            }
            
            .header-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .control-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }
            
            .search-header {
                justify-content: center;
            }
            
            .search-actions {
                flex-direction: column;
            }
            
            .search-button,
            .advanced-toggle {
                width: 100%;
            }
            
            .results-header {
                flex-direction: column;
                align-items: start;
            }
            
            .results-info {
                flex-direction: column;
                align-items: start;
                gap: 1rem;
            }
            
            .modal-content {
                margin: 2% 1rem;
                padding: 1.5rem;
            }
            
            .filter-group {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Print styles */
        @media print {
            header,
            .search-section,
            .pagination,
            .control-button,
            .export-button,
            .modal {
                display: none !important;
            }
            
            .result-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <img src="https://rcwac-histanth.whowp03.cc.tsukuba.ac.jp/content/uploads/sites/21/2021/07/logo.png" 
                         alt="筑波大学西アジア文明研究センター" 
                         class="logo-img">
                    <div class="logo-text">
                        <h1>UTsukuba RCWAC OPAC</h1>
                        <p data-i18n="header.subtitle">筑波大学西アジア文明研究センター蔵書デジタル目録</p>
                        <p style="font-size: 0.8rem; margin-top: 0.1rem;" data-i18n="header.subtitle2">University of Tsukuba, Research Center for West Asian Civilization, Digital Catalogue</p>
                    </div>
                </div>
                <div class="header-controls">
                    <button class="control-button" onclick="toggleLanguage()">
                        <span id="langIcon">🌐</span>
                        <span id="langText" data-i18n="controls.language">English</span>
                    </button>
                    <button class="control-button" onclick="toggleTheme()">
                        <span id="themeIcon">🌙</span>
                        <span id="themeText" data-i18n="controls.darkMode">ダークモード</span>
                    </button>
                    <button class="control-button" onclick="toggleStats()">
                        <span>📊</span>
                        <span data-i18n="controls.stats">統計</span>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <section class="status-section">
            <div class="container">
                <div class="status-message" id="statusMessage">
                    <span class="status-loading" data-i18n="status.loading">📖 RDFファイルを読み込み中...</span>
                </div>
            </div>
        </section>
        
        <section class="stats-section" id="statsSection">
            <div class="container">
                <h2 style="margin-bottom: 1rem; color: var(--text-primary);" data-i18n="stats.title">データベース統計</h2>
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be populated here -->
                </div>
            </div>
        </section>
        
        <section class="search-section">
            <div class="container">
                <div class="search-container">
                    <div class="search-header">
                        <button class="search-tab active" onclick="setSearchType('all')" data-i18n="search.all">総合検索</button>
                        <button class="search-tab" onclick="setSearchType('title')" data-i18n="search.title">書名検索</button>
                        <button class="search-tab" onclick="setSearchType('author')" data-i18n="search.author">著者検索</button>
                        <button class="search-tab" onclick="setSearchType('keyword')" data-i18n="search.keyword">キーワード検索</button>
                        <button class="search-tab" onclick="setSearchType('year')" data-i18n="search.year">出版年検索</button>
                        <button class="search-tab" onclick="setSearchType('callNumber')" data-i18n="search.callNumber">請求記号検索</button>
                    </div>
                    
                    <form class="search-form" onsubmit="performSearch(event)">
                        <div class="search-input-container">
                            <span class="search-icon">🔍</span>
                            <input type="text" class="search-input" data-i18n-placeholder="search.placeholder" placeholder="データを読み込み中..." id="searchInput" disabled>
                        </div>
                        
                        <div class="advanced-search" id="advancedSearch">
                            <h3 style="margin-bottom: 1rem; color: var(--text-primary);" data-i18n="search.advancedTitle">詳細検索オプション</h3>
                            <div class="filter-group">
                                <div class="filter-item">
                                    <label class="filter-label" data-i18n="filter.language">言語</label>
                                    <select class="filter-select" id="filterLanguage">
                                        <option value="" data-i18n="filter.all">すべて</option>
                                        <option value="日本語">日本語</option>
                                        <option value="英語">English</option>
                                        <option value="アラビア語">العربية</option>
                                        <option value="ヘブライ語">עברית</option>
                                        <option value="ドイツ語">Deutsch</option>
                                        <option value="フランス語">Français</option>
                                        <option value="ロシア語">Русский</option>
                                    </select>
                                </div>
                                <div class="filter-item">
                                    <label class="filter-label" data-i18n="filter.type">資料種別</label>
                                    <select class="filter-select" id="filterType">
                                        <option value="" data-i18n="filter.all">すべて</option>
                                        <option value="図書">図書</option>
                                        <option value="論文">論文</option>
                                        <option value="会議録">会議録</option>
                                        <option value="博士論文">博士論文</option>
                                        <option value="修士論文">修士論文</option>
                                    </select>
                                </div>
                                <div class="filter-item">
                                    <label class="filter-label" data-i18n="filter.yearFrom">出版年（開始）</label>
                                    <input type="number" class="filter-select" id="filterYearFrom" placeholder="例: 1990">
                                </div>
                                <div class="filter-item">
                                    <label class="filter-label" data-i18n="filter.yearTo">出版年（終了）</label>
                                    <input type="number" class="filter-select" id="filterYearTo" placeholder="例: 2024">
                                </div>
                            </div>
                        </div>
                        
                        <div class="search-actions">
                            <button type="submit" class="search-button" id="searchButton" data-i18n="search.button" disabled>検索実行</button>
                            <button type="button" class="advanced-toggle" onclick="toggleAdvancedSearch()" data-i18n="search.advanced">詳細検索</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
        
        <section class="results-section">
            <div class="container">
                <div class="results-header">
                    <div class="results-info">
                        <div class="results-count" id="resultsCount" data-i18n="results.loading">データベースを読み込み中...</div>
                        <button class="export-button" onclick="exportResults()" style="display: none;" id="exportButton">
                            <span>📥</span>
                            <span data-i18n="export.button">エクスポート</span>
                        </button>
                    </div>
                    <div class="sort-options">
                        <label for="sortSelect" style="color: var(--text-secondary);" data-i18n="sort.label">並び替え:</label>
                        <select id="sortSelect" class="sort-select" onchange="sortResults()">
                            <option value="relevance" data-i18n="sort.relevance">関連度順</option>
                            <option value="year-desc" data-i18n="sort.yearDesc">出版年（新しい順）</option>
                            <option value="year-asc" data-i18n="sort.yearAsc">出版年（古い順）</option>
                            <option value="title" data-i18n="sort.title">タイトル順</option>
                            <option value="author" data-i18n="sort.author">著者名順</option>
                        </select>
                    </div>
                </div>
                
                <div class="loader" id="loader">
                    <div class="loader-spinner"></div>
                    <p style="margin-top: 1rem; color: var(--text-secondary);" data-i18n="loader.searching">検索中...</p>
                </div>
                
                <div id="resultsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">⏳</div>
                        <p data-i18n="empty.loading">データベースを読み込んでいます...</p>
                    </div>
                </div>
                
                <div class="pagination" id="pagination"></div>
            </div>
        </section>
    </main>
    
    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <script>
        // Global variables
        let bibData = [];
        let currentSearchType = 'all';
        let currentSearchResults = [];
        let currentLanguage = 'ja';
        let currentPage = 1;
        const resultsPerPage = 20;
        let searchHistory = [];
        let debounceTimer = null;
        
        // Detect if running on GitHub Pages and adjust path accordingly
        const isGitHubPages = window.location.hostname.includes('github.io');
        const basePath = isGitHubPages && window.location.pathname !== '/' 
            ? window.location.pathname.replace(/\/[^\/]*$/, '') 
            : '';
        const RDF_FILENAME = basePath ? `${basePath}/library-data.rdf` : 'library-data.rdf';
        
        // Translation data
        const translations = {
            ja: {
                header: {
                    subtitle: '筑波大学西アジア文明研究センター蔵書デジタル目録',
                    subtitle2: 'University of Tsukuba, Research Center for West Asian Civilization, Digital Catalogue'
                },
                controls: {
                    language: 'English',
                    darkMode: 'ダークモード',
                    lightMode: 'ライトモード',
                    stats: '統計'
                },
                status: {
                    loading: '📖 RDFファイルを読み込み中...',
                    success: '✅ {filename} を読み込みました ({count}件の文献)',
                    error: '❌ エラー: {filename} が見つかりません。ファイルがHTMLと同じフォルダにあることを確認してください。'
                },
                search: {
                    all: '総合検索',
                    title: '書名検索',
                    author: '著者検索',
                    keyword: 'キーワード検索',
                    year: '出版年検索',
                    callNumber: '請求記号検索',
                    placeholder: '検索キーワードを入力してください...',
                    placeholderLoading: 'データを読み込み中...',
                    button: '検索実行',
                    advanced: '詳細検索',
                    advancedTitle: '詳細検索オプション'
                },
                filter: {
                    language: '言語',
                    type: '資料種別',
                    yearFrom: '出版年（開始）',
                    yearTo: '出版年（終了）',
                    all: 'すべて'
                },
                results: {
                    loading: 'データベースを読み込み中...',
                    database: 'データベース: {count}件',
                    searchResults: '検索結果: {count}件',
                    showing: '{from}-{to}件を表示 (全{total}件中)'
                },
                sort: {
                    label: '並び替え:',
                    relevance: '関連度順',
                    yearDesc: '出版年（新しい順）',
                    yearAsc: '出版年（古い順）',
                    title: 'タイトル順',
                    author: '著者名順'
                },
                loader: {
                    searching: '検索中...'
                },
                empty: {
                    loading: 'データベースを読み込んでいます...',
                    noResults: '検索結果が見つかりませんでした',
                    error: 'RDFファイルの読み込みに失敗しました',
                    fileName: 'ファイル名: {filename}'
                },
                detail: {
                    author: '著者',
                    unknownAuthor: '著者不明',
                    bibliographic: '書誌情報',
                    publicationInfo: '掲載情報',
                    abstract: '要旨',
                    keywords: 'キーワード',
                    identifiers: '識別子',
                    year: '出版年',
                    type: '種別',
                    language: '言語',
                    publisher: '出版社',
                    address: '出版地',
                    series: 'シリーズ',
                    number: '号',
                    edition: '版',
                    journal: '雑誌',
                    volume: '巻',
                    pages: 'ページ',
                    callNumber: '請求記号',
                    copied: 'コピーしました！',
                    export: 'エクスポート'
                },
                alert: {
                    dbNotLoaded: 'データベースがまだ読み込まれていません',
                    exported: 'エクスポートが完了しました'
                },
                stats: {
                    title: 'データベース統計',
                    totalRecords: '総レコード数',
                    languages: '言語別',
                    types: '資料種別',
                    yearRange: '出版年範囲',
                    recentAdditions: '最近の追加'
                },
                export: {
                    button: 'エクスポート',
                    bibtex: 'BibTeX形式',
                    csv: 'CSV形式',
                    json: 'JSON形式'
                },
                pagination: {
                    previous: '前へ',
                    next: '次へ',
                    page: 'ページ'
                }
            },
            en: {
                header: {
                    subtitle: 'University of Tsukuba, Research Center for West Asian Civilization, Digital Catalogue',
                    subtitle2: '筑波大学西アジア文明研究センター蔵書デジタル目録'
                },
                controls: {
                    language: '日本語',
                    darkMode: 'Dark Mode',
                    lightMode: 'Light Mode',
                    stats: 'Statistics'
                },
                status: {
                    loading: '📖 Loading RDF file...',
                    success: '✅ Loaded {filename} ({count} references)',
                    error: '❌ Error: {filename} not found. Please ensure the file is in the same folder as the HTML file.'
                },
                search: {
                    all: 'All Fields',
                    title: 'Title',
                    author: 'Author',
                    keyword: 'Keywords',
                    year: 'Year',
                    callNumber: 'Call Number',
                    placeholder: 'Enter search keywords...',
                    placeholderLoading: 'Loading data...',
                    button: 'Search',
                    advanced: 'Advanced Search',
                    advancedTitle: 'Advanced Search Options'
                },
                filter: {
                    language: 'Language',
                    type: 'Material Type',
                    yearFrom: 'Year From',
                    yearTo: 'Year To',
                    all: 'All'
                },
                results: {
                    loading: 'Loading database...',
                    database: 'Database: {count} items',
                    searchResults: 'Search results: {count} items',
                    showing: 'Showing {from}-{to} of {total} results'
                },
                sort: {
                    label: 'Sort by:',
                    relevance: 'Relevance',
                    yearDesc: 'Year (Newest first)',
                    yearAsc: 'Year (Oldest first)',
                    title: 'Title',
                    author: 'Author'
                },
                loader: {
                    searching: 'Searching...'
                },
                empty: {
                    loading: 'Loading database...',
                    noResults: 'No results found',
                    error: 'Failed to load RDF file',
                    fileName: 'File name: {filename}'
                },
                detail: {
                    author: 'Author(s)',
                    unknownAuthor: 'Unknown author',
                    bibliographic: 'Bibliographic Information',
                    publicationInfo: 'Publication Details',
                    abstract: 'Abstract',
                    keywords: 'Keywords',
                    identifiers: 'Identifiers',
                    year: 'Year',
                    type: 'Type',
                    language: 'Language',
                    publisher: 'Publisher',
                    address: 'Place',
                    series: 'Series',
                    number: 'Number',
                    edition: 'Edition',
                    journal: 'Journal',
                    volume: 'Volume',
                    pages: 'Pages',
                    callNumber: 'Call Number',
                    copied: 'Copied!',
                    export: 'Export'
                },
                alert: {
                    dbNotLoaded: 'Database not loaded yet',
                    exported: 'Export completed'
                },
                stats: {
                    title: 'Database Statistics',
                    totalRecords: 'Total Records',
                    languages: 'By Language',
                    types: 'By Type',
                    yearRange: 'Year Range',
                    recentAdditions: 'Recent Additions'
                },
                export: {
                    button: 'Export',
                    bibtex: 'BibTeX Format',
                    csv: 'CSV Format',
                    json: 'JSON Format'
                },
                pagination: {
                    previous: 'Previous',
                    next: 'Next',
                    page: 'Page'
                }
            }
        };
        
        // Language type mappings
        const languageNames = {
            ja: {
                'アラビア語': 'アラビア語',
                'ヘブライ語': 'ヘブライ語',
                '日本語': '日本語',
                'ロシア語': 'ロシア語',
                '英語': '英語',
                'ドイツ語': 'ドイツ語',
                'フランス語': 'フランス語',
                'アッカド語': 'アッカド語',
                'ウガリット語': 'ウガリット語',
                'エジプト語': 'エジプト語',
                '多言語': '多言語'
            },
            en: {
                'アラビア語': 'Arabic',
                'ヘブライ語': 'Hebrew',
                '日本語': 'Japanese',
                'ロシア語': 'Russian',
                '英語': 'English',
                'ドイツ語': 'German',
                'フランス語': 'French',
                'アッカド語': 'Akkadian',
                'ウガリット語': 'Ugaritic',
                'エジプト語': 'Egyptian',
                '多言語': 'Multilingual'
            }
        };
        
        // Entry type mappings
        const entryTypeNames = {
            ja: {
                '論文': '論文',
                '図書': '図書',
                '図書の一部': '図書の一部',
                '論文集の一部': '論文集の一部',
                '会議録': '会議録',
                '修士論文': '修士論文',
                '博士論文': '博士論文',
                '技術報告書': '技術報告書',
                'マニュアル': 'マニュアル',
                'その他': 'その他',
                '未刊行': '未刊行'
            },
            en: {
                '論文': 'Article',
                '図書': 'Book',
                '図書の一部': 'Book Chapter',
                '論文集の一部': 'In Collection',
                '会議録': 'Conference Paper',
                '修士論文': 'Master\'s Thesis',
                '博士論文': 'PhD Thesis',
                '技術報告書': 'Technical Report',
                'マニュアル': 'Manual',
                'その他': 'Other',
                '未刊行': 'Unpublished'
            }
        };
        
        // Get translation
        function t(key, replacements = {}) {
            const keys = key.split('.');
            let value = translations[currentLanguage];
            for (const k of keys) {
                value = value[k];
            }
            
            // Replace placeholders
            Object.keys(replacements).forEach(placeholder => {
                value = value.replace(`{${placeholder}}`, replacements[placeholder]);
            });
            
            return value;
        }
        
        // Safe storage access
        const safeStorage = {
            getItem: (key) => {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.log('localStorage not available, using defaults');
                    return null;
                }
            },
            setItem: (key, value) => {
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    console.log('localStorage not available, changes will not persist');
                }
            }
        };
        
        // Initialize theme and language
        function initSettings() {
            const savedTheme = safeStorage.getItem('theme') || 'light';
            const savedLang = safeStorage.getItem('language') || 'ja';
            
            document.documentElement.setAttribute('data-theme', savedTheme);
            currentLanguage = savedLang;
            document.documentElement.setAttribute('lang', savedLang);
            
            updateThemeToggle(savedTheme);
            updateLanguageToggle(savedLang);
            updateAllTranslations();
        }
        
        // Toggle theme
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            safeStorage.setItem('theme', newTheme);
            updateThemeToggle(newTheme);
        }
        
        function updateThemeToggle(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (theme === 'dark') {
                icon.textContent = '☀️';
                text.textContent = t('controls.lightMode');
            } else {
                icon.textContent = '🌙';
                text.textContent = t('controls.darkMode');
            }
        }
        
        // Toggle language
        function toggleLanguage() {
            const newLang = currentLanguage === 'ja' ? 'en' : 'ja';
            currentLanguage = newLang;
            safeStorage.setItem('language', newLang);
            document.documentElement.setAttribute('lang', newLang);
            updateLanguageToggle(newLang);
            updateAllTranslations();
            
            // Update search results if any
            if (currentSearchResults.length > 0) {
                displayResults(currentSearchResults);
            }
            
            // Update stats if visible
            const statsSection = document.getElementById('statsSection');
            if (statsSection.classList.contains('visible')) {
                updateStats();
            }
        }
        
        function updateLanguageToggle(lang) {
            const text = document.getElementById('langText');
            text.textContent = t('controls.language');
        }
        
        // Toggle stats
        function toggleStats() {
            const statsSection = document.getElementById('statsSection');
            statsSection.classList.toggle('visible');
            
            if (statsSection.classList.contains('visible')) {
                updateStats();
            }
        }
        
        // Update stats
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            
            // Calculate statistics
            const totalRecords = bibData.length;
            const languageCounts = {};
            const typeCounts = {};
            const years = [];
            
            bibData.forEach(item => {
                // Count languages
                const lang = languageNames[currentLanguage][item.language] || item.language;
                languageCounts[lang] = (languageCounts[lang] || 0) + 1;
                
                // Count types
                const type = entryTypeNames[currentLanguage][item.type] || item.type;
                typeCounts[type] = (typeCounts[type] || 0) + 1;
                
                // Collect years
                if (item.year && !isNaN(item.year)) {
                    years.push(parseInt(item.year));
                }
            });
            
            const minYear = Math.min(...years) || 'N/A';
            const maxYear = Math.max(...years) || 'N/A';
            
            // Sort language and type counts
            const topLanguages = Object.entries(languageCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([lang, count]) => `${lang}: ${count}`)
                .join('<br>');
            
            const topTypes = Object.entries(typeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([type, count]) => `${type}: ${count}`)
                .join('<br>');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalRecords}</div>
                    <div class="stat-label">${t('stats.totalRecords')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="font-size: 1rem; line-height: 1.5;">${topLanguages}</div>
                    <div class="stat-label">${t('stats.languages')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="font-size: 1rem; line-height: 1.5;">${topTypes}</div>
                    <div class="stat-label">${t('stats.types')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${minYear} - ${maxYear}</div>
                    <div class="stat-label">${t('stats.yearRange')}</div>
                </div>
            `;
        }
        
        // Toggle advanced search
        function toggleAdvancedSearch() {
            const advancedSearch = document.getElementById('advancedSearch');
            advancedSearch.classList.toggle('active');
        }
        
        // Update all translations
        function updateAllTranslations() {
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });
            
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                element.placeholder = t(key);
            });
            
            // Update theme toggle text
            const currentTheme = document.documentElement.getAttribute('data-theme');
            updateThemeToggle(currentTheme);
            
            // Update page title
            document.title = 'UTsukuba RCWAC OPAC | 筑波大学西アジア文明研究センター蔵書デジタル目録';
            
            // Update current status message if needed
            const statusMessage = document.getElementById('statusMessage');
            if (statusMessage.querySelector('.status-success')) {
                statusMessage.innerHTML = `<span class="status-success">${t('status.success', {filename: RDF_FILENAME, count: bibData.length})}</span>`;
            }
            
            // Update results count
            const resultsCount = document.getElementById('resultsCount');
            if (resultsCount.textContent.includes(':')) {
                updateResultsCount();
            }
        }
        
        // RDF Parser for Zotero
        class ZoteroRDFParser {
            constructor() {
                this.entries = [];
            }
            
            parse(rdfString) {
                this.entries = [];
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(rdfString, "text/xml");
                
                // Check for parsing errors
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    console.error('RDF parsing error:', parseError.textContent);
                    return [];
                }
                
                // Get all book entries
                const books = xmlDoc.querySelectorAll('Book');
                
                books.forEach(book => {
                    const entry = this.parseBook(book);
                    if (entry) {
                        this.entries.push(entry);
                    }
                });
                
                return this.entries;
            }
            
            parseBook(bookElement) {
                const entry = {};
                
                // Get citation key from rdf:about attribute
                const about = bookElement.getAttribute('rdf:about');
                entry.citationKey = about ? about.replace('#', '').replace('urn:', '') : 'unknown';
                
                // Title
                const titleElem = bookElement.querySelector('title');
                entry.title = titleElem ? titleElem.textContent : '';
                
                // Short title (if exists)
                const shortTitleElem = bookElement.querySelector('shortTitle');
                entry.shortTitle = shortTitleElem ? shortTitleElem.textContent : '';
                
                // Authors
                entry.authors = [];
                const authorSeq = bookElement.querySelector('authors Seq');
                if (authorSeq) {
                    authorSeq.querySelectorAll('Person').forEach(person => {
                        const surname = person.querySelector('surname');
                        const givenName = person.querySelector('givenName');
                        if (surname) {
                            const name = givenName 
                                ? `${givenName.textContent} ${surname.textContent}`
                                : surname.textContent;
                            entry.authors.push(name);
                        }
                    });
                }
                
                // Editors (if no authors)
                if (entry.authors.length === 0) {
                    const editorSeq = bookElement.querySelector('editors Seq');
                    if (editorSeq) {
                        editorSeq.querySelectorAll('Person').forEach(person => {
                            const surname = person.querySelector('surname');
                            const givenName = person.querySelector('givenName');
                            if (surname) {
                                const name = givenName 
                                    ? `${givenName.textContent} ${surname.textContent}`
                                    : surname.textContent;
                                entry.authors.push(name);
                            }
                        });
                    }
                }
                
                // Date/Year
                const dateElem = bookElement.querySelector('date');
                entry.year = dateElem ? dateElem.textContent : '';
                
                // Publisher
                const publisherName = bookElement.querySelector('publisher name');
                entry.publisher = publisherName ? publisherName.textContent : '';
                
                // Publisher location
                const publisherLocality = bookElement.querySelector('publisher locality');
                entry.address = publisherLocality ? publisherLocality.textContent : '';
                
                // Language
                const langElem = bookElement.querySelector('language');
                entry.language = langElem ? langElem.textContent : '';
                
                // Abstract
                const abstractElem = bookElement.querySelector('abstract');
                entry.abstract = abstractElem ? this.cleanAbstract(abstractElem.textContent) : '';
                
                // ISBN
                const identifierElems = bookElement.querySelectorAll('identifier');
                identifierElems.forEach(elem => {
                    const text = elem.textContent;
                    if (text.includes('ISBN')) {
                        entry.isbn = text.replace('ISBN ', '');
                    }
                });
                
                // Series
                const seriesTitle = bookElement.querySelector('isPartOf Series title');
                const seriesNumber = bookElement.querySelector('isPartOf Series identifier');
                if (seriesTitle || seriesNumber) {
                    entry.series = seriesTitle ? seriesTitle.textContent : '';
                    entry.number = seriesNumber ? seriesNumber.textContent : '';
                }
                
                // Volume
                const volumeElem = bookElement.querySelector('volume');
                entry.volume = volumeElem ? volumeElem.textContent : '';
                
                // Pages
                const pagesElem = bookElement.querySelector('numPages');
                entry.pages = pagesElem ? pagesElem.textContent : '';
                
                // Call number (LCC)
                const lccElem = bookElement.querySelector('subject LCC value');
                entry.callNumber = lccElem ? lccElem.textContent : '';
                
                // Keywords/Subjects
                entry.keywords = [];
                bookElement.querySelectorAll('subject AutomaticTag value').forEach(tag => {
                    const keywords = tag.textContent.split(/[;,]/).map(k => k.trim());
                    entry.keywords.push(...keywords);
                });
                
                // ISSN (from description)
                const descElem = bookElement.querySelector('description');
                if (descElem && descElem.textContent.includes('ISSN')) {
                    entry.issn = descElem.textContent.match(/ISSN[:\s]+([0-9-]+)/)?.[1] || descElem.textContent.replace('ISSN: ', '');
                }
                
                // Item type
                const itemTypeElem = bookElement.querySelector('itemType');
                entry.entryType = itemTypeElem ? itemTypeElem.textContent : 'book';
                
                return entry;
            }
            
            cleanAbstract(text) {
                // Remove special notation like $Cnote$V
                return text.replace(/\$\$C[^$]+\$\$V/g, '').trim();
            }
        }
        
        // Load RDF file on page load
        async function loadRDFFile() {
            const statusMessage = document.getElementById('statusMessage');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            
            let content = null;
            
            // Method 1: Try window.fs.readFile (for Claude environment)
            if (window.fs && window.fs.readFile) {
                try {
                    content = await window.fs.readFile(RDF_FILENAME, { encoding: 'utf8' });
                } catch (error) {
                    console.log('window.fs.readFile failed, trying fetch...');
                }
            }
            
            // Method 2: Try fetch (for web server and GitHub Pages)
            if (!content) {
                try {
                    // Try multiple paths for better compatibility
                    const pathsToTry = [
                        RDF_FILENAME,
                        './library-data.rdf',
                        'library-data.rdf'
                    ];
                    
                    for (const path of pathsToTry) {
                        try {
                            const response = await fetch(path);
                            if (response.ok) {
                                content = await response.text();
                                console.log(`Successfully loaded from: ${path}`);
                                break;
                            }
                        } catch (e) {
                            console.log(`Failed to load from ${path}`);
                        }
                    }
                } catch (error) {
                    console.log('All fetch attempts failed, showing manual upload option...');
                }
            }
            
            // If content was loaded successfully
            if (content) {
                // Parse the RDF content
                parseRDF(content);
                
                // Update status
                statusMessage.innerHTML = `<span class="status-success">${t('status.success', {filename: RDF_FILENAME, count: bibData.length})}</span>`;
                
                // Enable search
                searchInput.disabled = false;
                searchButton.disabled = false;
                searchInput.placeholder = t('search.placeholder');
                
                // Show export button
                document.getElementById('exportButton').style.display = 'flex';
                
                // Enable real-time search
                searchInput.addEventListener('input', handleSearchInput);
                
                // Update results count and display all results
                updateResultsCount();
                displayAllResults();
            } else {
                // Show manual upload option
                console.error('Could not load RDF file automatically');
                statusMessage.innerHTML = `
                    <span class="status-error">${currentLanguage === 'ja' 
                        ? '自動読み込みに失敗しました。' 
                        : 'Failed to load automatically.'}</span>
                    <input type="file" id="manualFileInput" accept=".rdf,.xml" style="display: none;">
                    <button class="control-button" style="margin-left: 1rem;" onclick="document.getElementById('manualFileInput').click()">
                        📁 ${currentLanguage === 'ja' ? 'ファイルを選択' : 'Select File'}
                    </button>
                `;
                
                // Add file input handler
                document.getElementById('manualFileInput').addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const content = e.target.result;
                            parseRDF(content);
                            
                            statusMessage.innerHTML = `<span class="status-success">${t('status.success', {filename: file.name, count: bibData.length})}</span>`;
                            
                            searchInput.disabled = false;
                            searchButton.disabled = false;
                            searchInput.placeholder = t('search.placeholder');
                            searchInput.addEventListener('input', handleSearchInput);
                            
                            document.getElementById('exportButton').style.display = 'flex';
                            
                            updateResultsCount();
                            displayAllResults();
                        };
                        reader.readAsText(file);
                    }
                });
                
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📁</div>
                        <p>${currentLanguage === 'ja' 
                            ? 'Zotero RDFファイルを選択してください' 
                            : 'Please select a Zotero RDF file'}</p>
                        <div class="info-box" style="text-align: left; max-width: 600px; margin: 2rem auto;">
                            <h4>${currentLanguage === 'ja' ? 'ファイル読み込みについて' : 'About File Loading'}</h4>
                            <p>${currentLanguage === 'ja' 
                                ? 'このシステムはZotero RDFファイルを読み込みます：' 
                                : 'This system loads Zotero RDF files:'}</p>
                            <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                <li>${currentLanguage === 'ja'
                                    ? 'Webサーバー経由: HTTPサーバーでホストされている場合、自動的に読み込みます'
                                    : 'Via web server: Automatically loads when hosted on an HTTP server'}</li>
                                <li>${currentLanguage === 'ja'
                                    ? '手動選択: ローカルファイルは上のボタンから選択してください'
                                    : 'Manual selection: Select local files using the button above'}</li>
                            </ul>
                            <p style="margin-top: 1rem;">${currentLanguage === 'ja'
                                ? '注意: デフォルトのファイル名は library-data.rdf です。'
                                : 'Note: The default filename is library-data.rdf'}</p>
                        </div>
                    </div>
                `;
            }
        }
        
        function parseRDF(content) {
            const parser = new ZoteroRDFParser();
            const entries = parser.parse(content);
            
            bibData = entries.map(entry => ({
                id: entry.citationKey,
                title: entry.title || 'No title',
                authors: entry.authors || [],
                year: entry.year || 'n.d.',
                type: mapEntryType(entry.entryType),
                journal: entry.journal || entry.booktitle || '',
                volume: entry.volume || '',
                pages: entry.pages || '',
                doi: entry.doi || '',
                isbn: entry.isbn || '',
                issn: entry.issn || '',
                publisher: entry.publisher || '',
                address: entry.address || '',
                abstract: entry.abstract || '',
                keywords: entry.keywords || [],
                series: entry.series || '',
                number: entry.number || '',
                edition: entry.edition || '',
                url: entry.url || '',
                note: entry.note || '',
                language: detectLanguage(entry.language || entry.title || ''),
                citationKey: entry.citationKey,
                callNumber: entry.callNumber || ''
            }));
        }
        
        function mapEntryType(type) {
            const typeMap = {
                'article': '論文',
                'book': '図書',
                'inbook': '図書の一部',
                'incollection': '論文集の一部',
                'inproceedings': '会議録',
                'conference': '会議録',
                'mastersthesis': '修士論文',
                'phdthesis': '博士論文',
                'techreport': '技術報告書',
                'manual': 'マニュアル',
                'misc': 'その他',
                'unpublished': '未刊行'
            };
            return typeMap[type.toLowerCase()] || type;
        }
        
        function detectLanguage(text) {
            // Check explicit language codes
            const langLower = text.toLowerCase();
            if (langLower === 'eng' || langLower === 'english') return '英語';
            if (langLower === 'jpn' || langLower === 'japanese') return '日本語';
            if (langLower === 'ger' || langLower === 'german') return 'ドイツ語';
            if (langLower === 'fre' || langLower === 'french') return 'フランス語';
            if (langLower === 'ara' || langLower === 'arabic') return 'アラビア語';
            if (langLower === 'heb' || langLower === 'hebrew') return 'ヘブライ語';
            if (langLower === 'akk' || langLower === 'akkadian') return 'アッカド語';
            if (langLower === 'uga' || langLower === 'ugaritic') return 'ウガリット語';
            if (langLower === 'egy' || langLower === 'egyptian') return 'エジプト語';
            if (langLower === 'rus' || langLower === 'russian') return 'ロシア語';
            
            // Handle multiple languages (e.g., "eng;jpn")
            if (langLower.includes(';')) {
                const langs = langLower.split(';').map(l => l.trim());
                const detectedLangs = langs.map(l => detectLanguage(l)).filter(l => l !== '英語');
                return detectedLangs.length > 0 ? detectedLangs.join('・') : '多言語';
            }
            
            // Character-based detection
            if (/[\u0600-\u06FF]/.test(text)) return 'アラビア語';
            if (/[\u0590-\u05FF]/.test(text)) return 'ヘブライ語';
            if (/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(text)) return '日本語';
            if (/[А-Яа-я]/.test(text)) return 'ロシア語';
            
            return '英語';
        }
        
        function setSearchType(type) {
            currentSearchType = type;
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function handleSearchInput(event) {
            // Clear previous timer
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
            
            // Set new timer
            debounceTimer = setTimeout(() => {
                const searchTerm = event.target.value.trim();
                if (searchTerm.length >= 2 || searchTerm.length === 0) {
                    performSearch(event);
                }
            }, 300);
        }
        
        function performSearch(event) {
            event.preventDefault();
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const loader = document.getElementById('loader');
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (bibData.length === 0) {
                alert(t('alert.dbNotLoaded'));
                return;
            }
            
            // Show loader
            loader.classList.add('active');
            resultsContainer.innerHTML = '';
            
            // Get filter values
            const filterLanguage = document.getElementById('filterLanguage').value;
            const filterType = document.getElementById('filterType').value;
            const filterYearFrom = document.getElementById('filterYearFrom').value;
            const filterYearTo = document.getElementById('filterYearTo').value;
            
            // Simulate search delay
            setTimeout(() => {
                if (!searchTerm && !filterLanguage && !filterType && !filterYearFrom && !filterYearTo) {
                    currentSearchResults = [...bibData];
                } else {
                    currentSearchResults = bibData.filter(item => {
                        // Search term filter
                        let matchesSearch = true;
                        if (searchTerm) {
                            let searchIn = '';
                            
                            switch (currentSearchType) {
                                case 'title':
                                    searchIn = item.title.toLowerCase();
                                    break;
                                case 'author':
                                    searchIn = item.authors.join(' ').toLowerCase();
                                    break;
                                case 'keyword':
                                    searchIn = item.keywords.join(' ').toLowerCase() + ' ' + item.abstract.toLowerCase();
                                    break;
                                case 'year':
                                    searchIn = item.year;
                                    break;
                                case 'callNumber':
                                    searchIn = item.callNumber ? item.callNumber.toLowerCase() : '';
                                    break;
                                default: // all
                                    searchIn = `${item.title} ${item.authors.join(' ')} ${item.abstract} ${item.keywords.join(' ')} ${item.journal} ${item.citationKey} ${item.year} ${item.publisher} ${item.callNumber}`.toLowerCase();
                            }
                            
                            matchesSearch = searchIn.includes(searchTerm);
                        }
                        
                        // Language filter
                        const matchesLanguage = !filterLanguage || item.language === filterLanguage;
                        
                        // Type filter
                        const matchesType = !filterType || item.type === filterType;
                        
                        // Year filter
                        let matchesYear = true;
                        if (filterYearFrom || filterYearTo) {
                            const itemYear = parseInt(item.year);
                            if (itemYear) {
                                if (filterYearFrom && itemYear < parseInt(filterYearFrom)) {
                                    matchesYear = false;
                                }
                                if (filterYearTo && itemYear > parseInt(filterYearTo)) {
                                    matchesYear = false;
                                }
                            } else {
                                matchesYear = false;
                            }
                        }
                        
                        return matchesSearch && matchesLanguage && matchesType && matchesYear;
                    });
                }
                
                // Add to search history
                if (searchTerm) {
                    searchHistory.unshift(searchTerm);
                    searchHistory = searchHistory.slice(0, 10); // Keep last 10 searches
                }
                
                // Reset to page 1
                currentPage = 1;
                
                // Apply current sort
                sortResults();
                
                // Hide loader
                loader.classList.remove('active');
                
                // Update results count
                updateResultsCount();
                
                // Display results
                displayResults(currentSearchResults);
            }, 300);
        }
        
        function displayAllResults() {
            currentSearchResults = [...bibData];
            currentPage = 1;
            displayResults(currentSearchResults);
        }
        
        function sortResults() {
            const sortType = document.getElementById('sortSelect').value;
            
            switch (sortType) {
                case 'year-desc':
                    currentSearchResults.sort((a, b) => (b.year || '0') - (a.year || '0'));
                    break;
                case 'year-asc':
                    currentSearchResults.sort((a, b) => (a.year || '9999') - (b.year || '9999'));
                    break;
                case 'title':
                    currentSearchResults.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'author':
                    currentSearchResults.sort((a, b) => {
                        const authorA = a.authors[0] || '';
                        const authorB = b.authors[0] || '';
                        return authorA.localeCompare(authorB);
                    });
                    break;
                default: // relevance or default
                    // Keep original order (relevance based on search)
                    break;
            }
            
            displayResults(currentSearchResults);
        }
        
        function updateResultsCount() {
            const resultsCount = document.getElementById('resultsCount');
            if (currentSearchResults.length > 0 && currentSearchResults.length !== bibData.length) {
                resultsCount.textContent = t('results.searchResults', { count: currentSearchResults.length });
            } else if (bibData.length > 0) {
                resultsCount.textContent = t('results.database', { count: bibData.length });
            }
        }
        
        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            const pagination = document.getElementById('pagination');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <p>${t('empty.noResults')}</p>
                    </div>
                `;
                pagination.innerHTML = '';
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(results.length / resultsPerPage);
            const start = (currentPage - 1) * resultsPerPage;
            const end = Math.min(start + resultsPerPage, results.length);
            const pageResults = results.slice(start, end);
            
            // Update results count with pagination info
            const resultsCount = document.getElementById('resultsCount');
            if (results.length > resultsPerPage) {
                resultsCount.textContent = `${t('results.showing', {
                    from: start + 1,
                    to: end,
                    total: results.length
                })}`;
            }
            
            container.innerHTML = '';
            
            pageResults.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.style.animationDelay = `${Math.min(index * 0.05, 0.5)}s`;
                
                const metaItems = [];
                if (item.year) metaItems.push(`<div class="meta-item"><span>📅</span><span>${item.year}</span></div>`);
                if (item.type) metaItems.push(`<div class="meta-item"><span>📚</span><span>${entryTypeNames[currentLanguage][item.type] || item.type}</span></div>`);
                if (item.language) metaItems.push(`<div class="meta-item"><span>🌐</span><span>${languageNames[currentLanguage][item.language] || item.language}</span></div>`);
                if (item.journal) metaItems.push(`<div class="meta-item"><span>📖</span><span>${item.journal}</span></div>`);
                if (item.volume) metaItems.push(`<div class="meta-item"><span>📕</span><span>Vol. ${item.volume}</span></div>`);
                if (item.pages) metaItems.push(`<div class="meta-item"><span>📄</span><span>pp. ${item.pages}</span></div>`);
                
                const keywordsHtml = item.keywords.length > 0 ? `
                    <div class="result-tags">
                        ${item.keywords.slice(0, 5).map(keyword => `<span class="tag">${keyword}</span>`).join('')}
                        ${item.keywords.length > 5 ? `<span class="tag">+${item.keywords.length - 5}</span>` : ''}
                    </div>
                ` : '';
                
                card.innerHTML = `
                    <div class="result-header">
                        <div style="width: 100%;">
                            <h3 class="result-title" onclick="showDetails('${item.id}')">${highlightSearchTerm(item.title)}</h3>
                            <div class="result-authors">${highlightSearchTerm(item.authors.join(', ') || t('detail.unknownAuthor'))}</div>
                        </div>
                    </div>
                    
                    <div class="result-meta">
                        ${metaItems.join('')}
                    </div>
                    
                    ${item.abstract ? `<p class="result-abstract">${highlightSearchTerm(truncateText(item.abstract, 200))}</p>` : ''}
                    
                    ${keywordsHtml}
                    
                    <div class="result-actions">
                        ${item.callNumber ? `
                            <div class="result-call-number" onclick="copyCallNumber('${item.callNumber}')">
                                <span>🏷️</span>
                                <span>${currentLanguage === 'ja' ? '請求記号' : 'Call Number'}: ${item.callNumber}</span>
                            </div>
                        ` : ''}
                        <div class="result-bibtex-key" onclick="copyBibTeXKey('${item.citationKey}')">
                            <span>🔑</span>
                            <span>Citation: ${item.citationKey}</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Display pagination
            displayPagination(totalPages);
        }
        
        function displayPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <button class="page-button" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
                    ${t('pagination.previous')}
                </button>
            `;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                paginationHTML += `<button class="page-button" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="page-info">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="page-button ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="page-info">...</span>`;
                }
                paginationHTML += `<button class="page-button" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            paginationHTML += `
                <button class="page-button" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
                    ${t('pagination.next')}
                </button>
            `;
            
            pagination.innerHTML = paginationHTML;
        }
        
        function goToPage(page) {
            currentPage = page;
            displayResults(currentSearchResults);
            
            // Scroll to top of results
            document.querySelector('.results-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        function highlightSearchTerm(text) {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }
        
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function showDetails(id) {
            const item = bibData.find(d => d.id === id);
            if (!item) return;
            
            const modal = document.getElementById('detailModal');
            const modalContent = document.getElementById('modalContent');
            
            const detailSections = [];
            
            detailSections.push(`
                <div class="detail-section">
                    <h2 style="color: var(--accent-blue); margin-bottom: 1rem;">${item.title}</h2>
                    ${item.callNumber ? `
                        <div class="result-call-number" style="margin-bottom: 1rem;" onclick="copyCallNumber('${item.callNumber}')">
                            <span>🏷️</span>
                            <span>${currentLanguage === 'ja' ? '請求記号' : 'Call Number'}: ${item.callNumber}</span>
                        </div>
                    ` : ''}
                </div>
            `);
            
            if (item.authors.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.author')}</div>
                        <div class="detail-value">${item.authors.join(', ')}</div>
                    </div>
                `);
            }
            
            const bibliographicInfo = [];
            if (item.year) bibliographicInfo.push(`${t('detail.year')}: ${item.year}`);
            if (item.type) bibliographicInfo.push(`${t('detail.type')}: ${entryTypeNames[currentLanguage][item.type] || item.type}`);
            if (item.language) bibliographicInfo.push(`${t('detail.language')}: ${languageNames[currentLanguage][item.language] || item.language}`);
            if (item.publisher) bibliographicInfo.push(`${t('detail.publisher')}: ${item.publisher}`);
            if (item.address) bibliographicInfo.push(`${t('detail.address')}: ${item.address}`);
            if (item.series) bibliographicInfo.push(`${t('detail.series')}: ${item.series}`);
            if (item.number) bibliographicInfo.push(`${t('detail.number')}: ${item.number}`);
            if (item.edition) bibliographicInfo.push(`${t('detail.edition')}: ${item.edition}`);
            
            if (bibliographicInfo.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.bibliographic')}</div>
                        <div class="detail-value">${bibliographicInfo.join('<br>')}</div>
                    </div>
                `);
            }
            
            if (item.journal || item.volume || item.pages) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.publicationInfo')}</div>
                        <div class="detail-value">
                            ${item.journal ? `${t('detail.journal')}: ${item.journal}<br>` : ''}
                            ${item.volume ? `${t('detail.volume')}: ${item.volume}<br>` : ''}
                            ${item.pages ? `${t('detail.pages')}: ${item.pages}` : ''}
                        </div>
                    </div>
                `);
            }
            
            if (item.abstract) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.abstract')}</div>
                        <div class="detail-value">${item.abstract}</div>
                    </div>
                `);
            }
            
            if (item.keywords.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.keywords')}</div>
                        <div class="detail-value">
                            <div class="result-tags">
                                ${item.keywords.map(keyword => `<span class="tag">${keyword}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `);
            }
            
            const identifiers = [];
            if (item.isbn) identifiers.push(`ISBN: ${item.isbn}`);
            if (item.issn) identifiers.push(`ISSN: ${item.issn}`);
            if (item.doi) identifiers.push(`DOI: ${item.doi}`);
            if (item.url) identifiers.push(`URL: <a href="${item.url}" target="_blank" style="color: var(--accent-blue);">${item.url}</a>`);
            
            if (identifiers.length > 0) {
                detailSections.push(`
                    <div class="detail-section">
                        <div class="detail-label">${t('detail.identifiers')}</div>
                        <div class="detail-value">${identifiers.join('<br>')}</div>
                    </div>
                `);
            }
            
            detailSections.push(`
                <div class="detail-section">
                    <div class="detail-label">Citation Key</div>
                    <div class="detail-value">
                        <div class="result-bibtex-key" style="display: inline-flex;" onclick="copyBibTeXKey('${item.citationKey}')">
                            <span>🔑</span>
                            <span>${item.citationKey}</span>
                        </div>
                    </div>
                </div>
            `);
            
            // Add export button for single item
            detailSections.push(`
                <div class="detail-section" style="text-align: center;">
                    <button class="export-button" onclick="exportSingleItem('${item.id}')">
                        <span>📥</span>
                        <span>${t('detail.export')}</span>
                    </button>
                </div>
            `);
            
            modalContent.innerHTML = detailSections.join('');
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        function copyCallNumber(callNumber) {
            navigator.clipboard.writeText(callNumber).then(() => {
                // Show feedback
                const callNumberElement = event.target.closest('.result-call-number');
                const originalHTML = callNumberElement.innerHTML;
                callNumberElement.innerHTML = `<span>✅</span><span>${t('detail.copied')}</span>`;
                setTimeout(() => {
                    callNumberElement.innerHTML = originalHTML;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert(`${currentLanguage === 'ja' ? '請求記号' : 'Call Number'}: ${callNumber}`);
            });
        }
        
        function copyBibTeXKey(key) {
            navigator.clipboard.writeText(`@${key}`).then(() => {
                // Show feedback
                const keyElement = event.target.closest('.result-bibtex-key');
                const originalHTML = keyElement.innerHTML;
                keyElement.innerHTML = `<span>✅</span><span>${t('detail.copied')}</span>`;
                setTimeout(() => {
                    keyElement.innerHTML = originalHTML;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert(`Citation Key: @${key}`);
            });
        }
        
        // Export functions
        function exportResults() {
            const format = prompt(
                currentLanguage === 'ja' 
                    ? 'エクスポート形式を選択してください:\n1. BibTeX\n2. CSV\n3. JSON\n\n番号を入力してください (1-3):'
                    : 'Select export format:\n1. BibTeX\n2. CSV\n3. JSON\n\nEnter number (1-3):'
            );
            
            if (!format) return;
            
            let content = '';
            let filename = '';
            const results = currentSearchResults.length > 0 ? currentSearchResults : bibData;
            
            switch (format) {
                case '1': // BibTeX
                    content = exportToBibTeX(results);
                    filename = 'rcwac-export.bib';
                    break;
                case '2': // CSV
                    content = exportToCSV(results);
                    filename = 'rcwac-export.csv';
                    break;
                case '3': // JSON
                    content = exportToJSON(results);
                    filename = 'rcwac-export.json';
                    break;
                default:
                    alert(currentLanguage === 'ja' ? '無効な選択です' : 'Invalid selection');
                    return;
            }
            
            downloadFile(content, filename);
            alert(t('alert.exported'));
        }
        
        function exportSingleItem(id) {
            const item = bibData.find(d => d.id === id);
            if (!item) return;
            
            const format = prompt(
                currentLanguage === 'ja' 
                    ? 'エクスポート形式を選択してください:\n1. BibTeX\n2. CSV\n3. JSON\n\n番号を入力してください (1-3):'
                    : 'Select export format:\n1. BibTeX\n2. CSV\n3. JSON\n\nEnter number (1-3):'
            );
            
            if (!format) return;
            
            let content = '';
            let filename = '';
            
            switch (format) {
                case '1': // BibTeX
                    content = exportToBibTeX([item]);
                    filename = `${item.citationKey}.bib`;
                    break;
                case '2': // CSV
                    content = exportToCSV([item]);
                    filename = `${item.citationKey}.csv`;
                    break;
                case '3': // JSON
                    content = exportToJSON([item]);
                    filename = `${item.citationKey}.json`;
                    break;
                default:
                    alert(currentLanguage === 'ja' ? '無効な選択です' : 'Invalid selection');
                    return;
            }
            
            downloadFile(content, filename);
        }
        
        function exportToBibTeX(items) {
            return items.map(item => {
                const type = item.type === '図書' ? 'book' : 
                           item.type === '論文' ? 'article' : 
                           item.type === '博士論文' ? 'phdthesis' : 
                           item.type === '修士論文' ? 'mastersthesis' : 'misc';
                
                let bibtex = `@${type}{${item.citationKey},\n`;
                bibtex += `  title = {${item.title}},\n`;
                if (item.authors.length > 0) {
                    bibtex += `  author = {${item.authors.join(' and ')}},\n`;
                }
                if (item.year) bibtex += `  year = {${item.year}},\n`;
                if (item.publisher) bibtex += `  publisher = {${item.publisher}},\n`;
                if (item.address) bibtex += `  address = {${item.address}},\n`;
                if (item.journal) bibtex += `  journal = {${item.journal}},\n`;
                if (item.volume) bibtex += `  volume = {${item.volume}},\n`;
                if (item.pages) bibtex += `  pages = {${item.pages}},\n`;
                if (item.isbn) bibtex += `  isbn = {${item.isbn}},\n`;
                if (item.issn) bibtex += `  issn = {${item.issn}},\n`;
                if (item.doi) bibtex += `  doi = {${item.doi}},\n`;
                if (item.abstract) bibtex += `  abstract = {${item.abstract}},\n`;
                if (item.keywords.length > 0) {
                    bibtex += `  keywords = {${item.keywords.join(', ')}},\n`;
                }
                if (item.callNumber) bibtex += `  note = {Call Number: ${item.callNumber}},\n`;
                
                // Remove last comma and newline
                bibtex = bibtex.slice(0, -2) + '\n';
                bibtex += '}\n\n';
                
                return bibtex;
            }).join('');
        }
        
        function exportToCSV(items) {
            const headers = ['Citation Key', 'Title', 'Authors', 'Year', 'Type', 'Language', 'Publisher', 'Journal', 'Volume', 'Pages', 'Call Number', 'Keywords'];
            
            const csvContent = [
                headers.join(','),
                ...items.map(item => [
                    `"${item.citationKey}"`,
                    `"${item.title.replace(/"/g, '""')}"`,
                    `"${item.authors.join('; ').replace(/"/g, '""')}"`,
                    item.year,
                    `"${item.type}"`,
                    `"${item.language}"`,
                    `"${item.publisher.replace(/"/g, '""')}"`,
                    `"${item.journal.replace(/"/g, '""')}"`,
                    item.volume,
                    item.pages,
                    `"${item.callNumber}"`,
                    `"${item.keywords.join('; ').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');
            
            return '\ufeff' + csvContent; // Add BOM for Excel compatibility
        }
        
        function exportToJSON(items) {
            return JSON.stringify(items, null, 2);
        }
        
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Initialize on page load
        window.onload = () => {
            // Check for sandboxed environment
            try {
                localStorage.getItem('test');
            } catch (e) {
                console.log('Running in sandboxed environment - settings will not persist');
            }
            
            initSettings();
            loadRDFFile();
        };
    </script>
</body>
</html>